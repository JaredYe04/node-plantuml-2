# é¡¹ç›®æ¶æ„å’Œæ‰§è¡Œæµç¨‹åˆ†æ

## ğŸ“‹ ç›®å½•
1. [å½“å‰æ‰§è¡Œæµç¨‹](#å½“å‰æ‰§è¡Œæµç¨‹)
2. [æ¶æ„é“¾è·¯å›¾](#æ¶æ„é“¾è·¯å›¾)
3. [Javaè°ƒç”¨æœºåˆ¶](#javaè°ƒç”¨æœºåˆ¶)
4. [åºŸå¼ƒä»£ç æ¸…å•](#åºŸå¼ƒä»£ç æ¸…å•)
5. [çº¯Nodeè¿ç§»å»ºè®®](#çº¯nodeè¿ç§»å»ºè®®)

---

## å½“å‰æ‰§è¡Œæµç¨‹

### ç”¨æˆ·è°ƒç”¨ â†’ ç”Ÿæˆå›¾è¡¨

```
ç”¨æˆ·ä»£ç 
  â†“
plantuml.generate() [lib/node-plantuml.js]
  â†“
å¤„ç†è¾“å…¥ï¼ˆæ–‡ä»¶/æ–‡æœ¬/stdinï¼‰
  â†“
æ·»åŠ å­—ä½“é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
  â†“
è¯­æ³•ä¿®å¤ï¼ˆå¦‚æœå¯ç”¨ï¼‰
  â†“
plantumlExecutor.exec() [lib/plantuml-executor.js]
  â†“
å°è¯•Wasmæ‰§è¡Œå™¨ï¼ˆä½†å®é™…ä¸å¯ç”¨ï¼‰
  â†“
è‡ªåŠ¨fallbackåˆ°Javaæ‰§è¡Œå™¨
  â”œâ”€ æ–¹å¼1: Nailgunï¼ˆå¦‚æœå·²å¯åŠ¨ï¼‰
  â””â”€ æ–¹å¼2: child_process.spawn('java', ...)
  â†“
è°ƒç”¨ vendor/plantuml.jar
  â†“
è¿”å›PNG/SVG/ç­‰æ ¼å¼çš„è¾“å‡ºæµ
```

### è¯¦ç»†ä»£ç è°ƒç”¨é“¾

1. **å…¥å£ç‚¹** (`index.js`)
   ```javascript
   module.exports = require('./lib/node-plantuml')
   ```

2. **ä¸»æ¨¡å—** (`lib/node-plantuml.js`)
   - `generate()` - ç”Ÿæˆå›¾è¡¨çš„ä¸»è¦å‡½æ•°
   - `encode()` - ç¼–ç PlantUMLæºç 
   - `decode()` - è§£ç URLç¼–ç çš„PlantUML
   - `fixSyntax()` - è¯­æ³•ä¿®å¤æœåŠ¡

3. **æ‰§è¡Œå™¨** (`lib/plantuml-executor.js`)
   - `exec()` - æ‰§è¡ŒPlantUMLå‘½ä»¤çš„æ ¸å¿ƒå‡½æ•°
   - å°è¯•Wasmæ‰§è¡Œå™¨ï¼ˆç¬¬86-132è¡Œï¼‰
   - Fallbackåˆ°Javaæ‰§è¡Œå™¨ï¼ˆç¬¬144-165è¡Œï¼‰

4. **Javaæ‰§è¡Œå™¨å®ç°**
   - `execWithSpawn()` - ä½¿ç”¨ `child_process.spawn('java', ...)` å¯åŠ¨JVM
   - `execWithNailgun()` - ä½¿ç”¨NailgunåŠ é€ŸJavaå¯åŠ¨ï¼ˆä¿æŒJVMå¸¸é©»ï¼‰

---

## æ¶æ„é“¾è·¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·åº”ç”¨ä»£ç                               â”‚
â”‚  const plantuml = require('node-plantuml-2')                â”‚
â”‚  plantuml.generate('@startuml\nA -> B\n@enduml')           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              lib/node-plantuml.js                            â”‚
â”‚  - generate()                                               â”‚
â”‚  - å¤„ç†è¾“å…¥ï¼ˆæ–‡ä»¶/æ–‡æœ¬/stdinï¼‰                              â”‚
â”‚  - æ·»åŠ å­—ä½“é…ç½®ï¼ˆCJKå­—ç¬¦æ£€æµ‹ï¼‰                              â”‚
â”‚  - è¯­æ³•ä¿®å¤ï¼ˆå¯é€‰ï¼‰                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          lib/plantuml-executor.js                            â”‚
â”‚  exec() å‡½æ•°é€»è¾‘ï¼š                                          â”‚
â”‚  1. æ£€æŸ¥ PLANTUML_USE_JAVA ç¯å¢ƒå˜é‡                        â”‚
â”‚  2. å°è¯• Wasm æ‰§è¡Œå™¨ï¼ˆä½†å®é™…ä¸å¯ç”¨ï¼‰                        â”‚
â”‚  3. Fallback åˆ° Java æ‰§è¡Œå™¨                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â†“                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Wasmæ‰§è¡Œå™¨       â”‚    â”‚ Javaæ‰§è¡Œå™¨               â”‚
â”‚ (ä¸å¯ç”¨/åºŸå¼ƒ)    â”‚    â”‚                          â”‚
â”‚                  â”‚    â”‚ 1. execWithNailgun()     â”‚
â”‚ - æ£€æµ‹æ–‡ä»¶å­˜åœ¨   â”‚    â”‚    â†’ Nailgunå®¢æˆ·ç«¯       â”‚
â”‚ - å°è¯•åˆå§‹åŒ–     â”‚    â”‚    â†’ ä¿æŒJVMå¸¸é©»         â”‚
â”‚ - æ€»æ˜¯å¤±è´¥       â”‚    â”‚                          â”‚
â”‚ - è¿”å›fallback   â”‚    â”‚ 2. execWithSpawn()       â”‚
â”‚                  â”‚    â”‚    â†’ child_process.spawn â”‚
â”‚                  â”‚    â”‚    â†’ 'java -jar ...'     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ç³»ç»ŸJavaç¯å¢ƒ                â”‚
                    â”‚  java -jar plantuml.jar      â”‚
                    â”‚  vendor/plantuml.jar         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  è¾“å‡ºæµ (PNG/SVG/EPSç­‰)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Javaè°ƒç”¨æœºåˆ¶

### 1. ç›´æ¥Spawnæ–¹å¼ï¼ˆé»˜è®¤ï¼Œå¦‚æœNailgunæœªå¯åŠ¨ï¼‰

**ä»£ç ä½ç½®**: `lib/plantuml-executor.js:51-62`

```javascript
function execWithSpawn (argv, cwd, cb) {
  cwd = cwd || process.cwd()
  var opts = [
    '-Dplantuml.include.path=' + cwd,
    '-Djava.awt.headless=true',
    '-Dfile.encoding=UTF-8',
    '-Duser.language=en',
    '-Duser.country=US',
    '-jar', PLANTUML_JAR
  ].concat(argv)
  return childProcess.spawn('java', opts)
}
```

**å·¥ä½œåŸç†**:
- ä½¿ç”¨ Node.js çš„ `child_process.spawn()` å¯åŠ¨æ–°çš„Javaè¿›ç¨‹
- æ¯æ¬¡è°ƒç”¨éƒ½ä¼šå¯åŠ¨æ–°çš„JVMå®ä¾‹ï¼ˆè¾ƒæ…¢ï¼‰
- éœ€è¦ç³»ç»Ÿå®‰è£…Javaè¿è¡Œæ—¶ç¯å¢ƒ

**JVMå‚æ•°è¯´æ˜**:
- `-Dplantuml.include.path`: è®¾ç½®PlantUMLæ–‡ä»¶åŒ…å«è·¯å¾„
- `-Djava.awt.headless=true`: æ— å¤´æ¨¡å¼ï¼ˆæ— GUIï¼‰
- `-Dfile.encoding=UTF-8`: ä½¿ç”¨UTF-8ç¼–ç 
- `-jar plantuml.jar`: è¿è¡ŒPlantUML JARæ–‡ä»¶

### 2. Nailgunæ–¹å¼ï¼ˆåŠ é€Ÿï¼Œä½†éœ€è¦å…ˆå¯åŠ¨ï¼‰

**ä»£ç ä½ç½®**: `lib/plantuml-executor.js:21-48`

```javascript
module.exports.useNailgun = function (callback) {
  // å¯åŠ¨NailgunæœåŠ¡å™¨
  nailgunServer = nailgun.createServer(options, function (port) {
    // åŠ è½½JARåˆ°classpath
    ngClient.exec('ng-cp', [PLANTUML_JAR], clientOptions)
    ngClient.exec('ng-cp', [PLANTUML_NAIL_JAR], clientOptions)
    // ...
  })
}
```

**å·¥ä½œåŸç†**:
- Nailgunä¿æŒJVMè¿›ç¨‹å¸¸é©»å†…å­˜
- é€šè¿‡TCP socketé€šä¿¡ï¼Œé¿å…é‡å¤å¯åŠ¨JVM
- å¯åŠ¨é€Ÿåº¦æ›´å¿«ï¼Œä½†éœ€è¦é¢å¤–çš„æœåŠ¡å™¨è¿›ç¨‹

**ä¾èµ–**:
- `node-nailgun-server` - NailgunæœåŠ¡å™¨
- `node-nailgun-client` - Nailgunå®¢æˆ·ç«¯
- `nail/plantumlnail.jar` - NailgunåŒ…è£…çš„PlantUMLç±»

### 3. æ‰§è¡Œå™¨é€‰æ‹©é€»è¾‘

**ä»£ç ä½ç½®**: `lib/plantuml-executor.js:76-139`

```javascript
module.exports.exec = function (argv, cwd, callback) {
  // 1. ä¼˜å…ˆå°è¯•Wasmï¼ˆä½†å®é™…ä¸å¯ç”¨ï¼‰
  if (!useJava && wasmExecutor.isAvailable()) {
    // å°è¯•Wasm...
    // æ€»æ˜¯å¤±è´¥ï¼Œfallbackåˆ°Java
  }
  
  // 2. Fallbackåˆ°Javaæ‰§è¡Œå™¨
  return getJavaTask(argv, cwd, callback)
}

function getJavaTask (argv, cwd, callback) {
  // å¦‚æœNailgunå·²å¯åŠ¨ï¼Œä½¿ç”¨Nailgun
  if (nailgunRunning) {
    return execWithNailgun(argv, cwd, callback)
  } else {
    // å¦åˆ™ä½¿ç”¨ç›´æ¥spawn
    return execWithSpawn(argv, cwd, callback)
  }
}
```

---

## åºŸå¼ƒä»£ç æ¸…å•

### ğŸ”´ å®Œå…¨åºŸå¼ƒï¼ˆæ— æ³•å·¥ä½œï¼Œåº”åˆ é™¤ï¼‰

#### 1. Wasmæ‰§è¡Œå™¨ç›¸å…³ä»£ç 

**æ–‡ä»¶**: `lib/plantuml-executor-wasm.js`
- **çŠ¶æ€**: å®Œå…¨ä¸å¯ç”¨
- **åŸå› **: 
  - Bytecoderä¸æ”¯æŒ `ResourceBundle.getBundle()`ï¼ˆPlantUMLä¾èµ–ï¼‰
  - Wasmæ¨¡å—æ— æ³•æ­£ç¡®åˆå§‹åŒ–
  - æ‰€æœ‰æ‰§è¡Œéƒ½ä¼šfallbackåˆ°Java
- **è¡Œæ•°**: 329è¡Œï¼ˆæ•´ä¸ªæ–‡ä»¶ï¼‰
- **å»ºè®®**: åˆ é™¤æˆ–æ ‡è®°ä¸ºå®éªŒæ€§ä»£ç 

**ä¸»è¦åºŸå¼ƒå‡½æ•°**:
- `initWasm()` - Wasmåˆå§‹åŒ–ï¼ˆæ€»æ˜¯å¤±è´¥ï¼‰
- `execWithWasm()` - Wasmæ‰§è¡Œï¼ˆä»æœªæˆåŠŸï¼‰
- `processWasmExecution()` - å¤„ç†Wasmæ‰§è¡Œï¼ˆä¸å®Œæ•´å®ç°ï¼‰
- `initCheerpJ()` - CheerpJåˆå§‹åŒ–ï¼ˆä»æœªè¢«è°ƒç”¨ï¼‰
- `initWasmSync()` - åŒæ­¥åˆå§‹åŒ–ï¼ˆä¸å·¥ä½œï¼‰

#### 2. Wasmæ„å»ºè„šæœ¬

**æ–‡ä»¶**: `scripts/build-plantuml-wasm.js`
- **çŠ¶æ€**: æ„å»ºå¤±è´¥
- **åŸå› **: Bytecoder/TeaVMæ— æ³•å®Œæ•´ç¼–è¯‘PlantUML
- **è¡Œæ•°**: 900è¡Œ
- **å»ºè®®**: ç§»è‡³ `scripts/deprecated/` æˆ–åˆ é™¤

**ç›¸å…³æ–‡ä»¶**:
- `scripts/build-wasm-maven.js` (138è¡Œ)
- `scripts/build-plantuml-cheerpj.js` (293è¡Œ)
- `scripts/test-wasm-build.js` (å¦‚æœå­˜åœ¨)

#### 3. Mavenæ„å»ºé…ç½®

**æ–‡ä»¶**: `pom.xml`
- **çŠ¶æ€**: ç”¨äºWasmæ„å»ºï¼Œä½†æ„å»ºå¤±è´¥
- **å»ºè®®**: å¦‚æœä¸å†å°è¯•Wasmæ„å»ºï¼Œå¯ä»¥åˆ é™¤

#### 4. Wasmç›¸å…³æ–‡æ¡£ï¼ˆè¯¯å¯¼æ€§ï¼‰

ä»¥ä¸‹æ–‡æ¡£æåˆ°Wasmä½†å®é™…ä¸å¯ç”¨ï¼Œé€ æˆè¯¯å¯¼ï¼š

- `docs/WASM_IMPLEMENTATION.md` - æè¿°Wasmå®ç°ï¼Œä½†ä¸å·¥ä½œ
- `docs/WASM_BUILD_ARCHITECTURE.md` - Wasmæ„å»ºæ¶æ„
- `docs/WASM_BUILD_LIMITATIONS.md` - âœ… **ä¿ç•™**ï¼ˆè¯´æ˜ä¸ºä»€ä¹ˆä¸å¯ç”¨ï¼‰
- `docs/WASM_INTEGRATION.md` - Wasmé›†æˆæŒ‡å—
- `docs/README_WASM.md` - Wasmä½¿ç”¨è¯´æ˜
- `docs/PURE_NODE_IMPLEMENTATION.md` - æåˆ°Wasmä½†å®é™…æœªå®Œæˆ
- `docs/ROADMAP_PURE_NODE.md` - çº¯Nodeè·¯çº¿å›¾

**å»ºè®®**: 
- åˆ é™¤æˆ–ç§»è‡³ `docs/deprecated/`
- ä¿ç•™ `WASM_BUILD_LIMITATIONS.md` ä½œä¸ºè¯´æ˜æ–‡æ¡£

#### 5. æœªä½¿ç”¨çš„ç¯å¢ƒå˜é‡

**ä»£ç ä½ç½®**: `lib/plantuml-executor.js:88`
```javascript
// PLANTUML_USE_WASM - åœ¨ä»£ç ä¸­æ£€æŸ¥ä½†ä»æœªçœŸæ­£ä½¿ç”¨
// å®é™…ä½¿ç”¨çš„æ˜¯ PLANTUML_USE_JAVA
```

**åºŸå¼ƒçš„ç¯å¢ƒå˜é‡**:
- `PLANTUML_USE_WASM` - åœ¨å¤šä¸ªåœ°æ–¹å¼•ç”¨ï¼Œä½†Wasmä¸å¯ç”¨ï¼Œåº”è¯¥åˆ é™¤ç›¸å…³æ£€æŸ¥

#### 6. Wasmæµ‹è¯•æ–‡ä»¶

**æ–‡ä»¶**: `test/wasm-executor-test.js`
- **çŠ¶æ€**: æµ‹è¯•Wasmæ‰§è¡Œå™¨ï¼Œä½†Wasmä¸å¯ç”¨
- **å»ºè®®**: åˆ é™¤æˆ–æ ‡è®°ä¸ºè·³è¿‡

#### 7. vendor/wasm ç›®å½•ä¸­çš„æ–‡ä»¶

**ç›®å½•**: `vendor/wasm/`
- å¦‚æœWasmæ„å»ºä»æœªæˆåŠŸï¼Œè¿™äº›æ–‡ä»¶å¯èƒ½ä¸å­˜åœ¨æˆ–æ— æ•ˆ
- `plantuml.wasm` - å¦‚æœå­˜åœ¨ä½†ä¸å¯ç”¨
- `plantuml-core.js` - CheerpJç›¸å…³ï¼Œæœªä½¿ç”¨
- `plantuml-core.wasm` - CheerpJç›¸å…³ï¼Œæœªä½¿ç”¨

### ğŸŸ¡ éƒ¨åˆ†åºŸå¼ƒï¼ˆéœ€è¦æ¸…ç†ï¼‰

#### 1. plantuml-executor.js ä¸­çš„Wasmå°è¯•é€»è¾‘

**ä»£ç ä½ç½®**: `lib/plantuml-executor.js:86-132`

```javascript
// å°è¯•Wasmæ‰§è¡Œå™¨çš„ä»£ç ï¼ˆç¬¬86-132è¡Œï¼‰
// è¿™éƒ¨åˆ†ä»£ç æ€»æ˜¯fallbackåˆ°Javaï¼Œå¯ä»¥ç®€åŒ–
if (!useJava && wasmExecutor.isAvailable()) {
  // ... å°è¯•Wasmçš„ä»£ç  ...
  // æ€»æ˜¯å¤±è´¥ï¼Œæœ€ç»ˆè°ƒç”¨ getJavaTask()
}
```

**å»ºè®®**: 
- å¦‚æœç¡®å®šä¸å†å°è¯•Wasmï¼Œåˆ é™¤è¿™æ®µä»£ç 
- ç›´æ¥ä½¿ç”¨Javaæ‰§è¡Œå™¨
- ç®€åŒ– `exec()` å‡½æ•°é€»è¾‘

#### 2. useWasm() å‡½æ•°

**ä»£ç ä½ç½®**: `lib/plantuml-executor.js:64-74`

```javascript
module.exports.useWasm = function (callback) {
  // å¯¼å‡ºä½†ä»æœªè¢«å¤–éƒ¨è°ƒç”¨
  // å¦‚æœWasmä¸å¯ç”¨ï¼Œè¿™ä¸ªå‡½æ•°åº”è¯¥åˆ é™¤
}
```

**å»ºè®®**: åˆ é™¤æˆ–æ ‡è®°ä¸ºåºŸå¼ƒ

#### 3. package.json ä¸­çš„Wasmç›¸å…³è„šæœ¬

**æ–‡ä»¶**: `package.json`

```json
{
  "scripts": {
    "build:wasm": "...",           // åºŸå¼ƒ
    "build:wasm:cheerpj": "...",   // åºŸå¼ƒ
    "build:wasm:bytecoder": "...", // åºŸå¼ƒ
    "build:wasm:publish": "...",   // åºŸå¼ƒ
    "build:all": "...",            // éƒ¨åˆ†åºŸå¼ƒï¼ˆåŒ…å«wasmæ„å»ºï¼‰
    "build:all:wasm-only": "..."   // åºŸå¼ƒ
  }
}
```

**å»ºè®®**: åˆ é™¤Wasmç›¸å…³è„šæœ¬

#### 4. package.json files å­—æ®µä¸­çš„Wasmæ–‡ä»¶

```json
{
  "files": [
    "vendor/wasm/plantuml.wasm",  // å¦‚æœä¸å­˜åœ¨æˆ–ä¸å¯ç”¨ï¼Œåº”åˆ é™¤
    // ...
  ]
}
```

### âœ… ä¿ç•™çš„ä»£ç ï¼ˆå®é™…åœ¨ä½¿ç”¨ï¼‰

1. **Javaæ‰§è¡Œå™¨** (`lib/plantuml-executor.js`)
   - `execWithSpawn()` âœ…
   - `execWithNailgun()` âœ…
   - `getJavaTask()` âœ…
   - `useNailgun()` âœ…

2. **ä¸»æ¨¡å—** (`lib/node-plantuml.js`) âœ…

3. **å‘½ä»¤è¡Œå·¥å…·** (`lib/node-plantuml-cmd.js`) âœ…

4. **è¯­æ³•ä¿®å¤** (`lib/plantuml-syntax-fixer.js`) âœ…

5. **å­—ä½“è‡ªåŠ¨é…ç½®** (`lib/node-plantuml.js` ä¸­çš„å­—ä½“ç›¸å…³å‡½æ•°) âœ…

---

## çº¯Nodeè¿ç§»å»ºè®®

### å½“å‰é—®é¢˜æ€»ç»“

1. **Wasmæ–¹æ¡ˆå¤±è´¥**: Bytecoder/TeaVMæ— æ³•å®Œæ•´ç¼–è¯‘PlantUMLï¼ˆ`ResourceBundle.getBundle()`ä¸æ”¯æŒï¼‰
2. **CheerpJæ–¹æ¡ˆæœªå®Œæˆ**: `build-plantuml-cheerpj.js` å­˜åœ¨ä½†æœªé›†æˆ
3. **ä»£ç æ··ä¹±**: å¤§é‡åºŸå¼ƒçš„Wasmå°è¯•ä»£ç å¹²æ‰°ä¸»è¦é€»è¾‘
4. **æ–‡æ¡£è¯¯å¯¼**: å¤šå¤„æ–‡æ¡£æåˆ°Wasmæ”¯æŒï¼Œä½†å®é™…ä¸å¯ç”¨

### è¿ç§»æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1: æ¸…ç†å¹¶æ˜ç¡®ä½¿ç”¨Javaï¼ˆçŸ­æœŸï¼‰

**æ­¥éª¤**:
1. åˆ é™¤æ‰€æœ‰Wasmç›¸å…³ä»£ç 
2. ç®€åŒ– `plantuml-executor.js`ï¼Œç§»é™¤Wasmå°è¯•é€»è¾‘
3. æ›´æ–°æ–‡æ¡£ï¼Œæ˜ç¡®è¯´æ˜éœ€è¦Javaç¯å¢ƒ
4. ä¿ç•™Nailgunä¼˜åŒ–ï¼ˆåŠ é€ŸJavaå¯åŠ¨ï¼‰

**ä¼˜ç‚¹**:
- ä»£ç æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
- æ€§èƒ½ç¨³å®šå¯é 
- å®Œå…¨æ”¯æŒPlantUMLåŠŸèƒ½

**ç¼ºç‚¹**:
- ä»ç„¶éœ€è¦Javaç¯å¢ƒ
- ä¸ç¬¦åˆ"çº¯Node"çš„ç›®æ ‡

#### æ–¹æ¡ˆ2: æ¢ç´¢CheerpJæ–¹æ¡ˆï¼ˆä¸­æœŸï¼‰

**CheerpJæ˜¯ä»€ä¹ˆ**:
- å°†Javaå­—èŠ‚ç ç¼–è¯‘ä¸ºJavaScriptå’ŒWebAssembly
- å®˜æ–¹PlantUMLé¡¹ç›®æœ‰ `plantuml-core` ä½¿ç”¨CheerpJ

**æ­¥éª¤**:
1. ç ”ç©¶ `plantuml-core` é¡¹ç›®
2. é›†æˆCheerpJç¼–è¯‘çš„PlantUMLåˆ°Node.jsç¯å¢ƒ
3. å®ç°CheerpJè¿è¡Œæ—¶æ¡¥æ¥
4. æµ‹è¯•å®Œæ•´åŠŸèƒ½

**ä¼˜ç‚¹**:
- å¯èƒ½æ˜¯æœ€æ¥è¿‘"çº¯Node"çš„æ–¹æ¡ˆ
- æœ‰å®˜æ–¹PlantUMLæ”¯æŒ

**ç¼ºç‚¹**:
- CheerpJè¿è¡Œæ—¶å¯èƒ½è¾ƒå¤§
- éœ€è¦Node.jsç¯å¢ƒæ”¯æŒï¼ˆå¯èƒ½éœ€è¦ç‰¹æ®Šè¿è¡Œæ—¶ï¼‰

**ä»£ç ä½ç½®**: `scripts/build-plantuml-cheerpj.js`ï¼ˆå·²å­˜åœ¨ä½†æœªå®Œæˆï¼‰

#### æ–¹æ¡ˆ3: ä½¿ç”¨PlantUMLå®˜æ–¹WebæœåŠ¡ï¼ˆå¤‡é€‰ï¼‰

**æ­¥éª¤**:
1. ä½¿ç”¨PlantUMLåœ¨çº¿æœåŠ¡API
2. æˆ–æ­å»ºæœ¬åœ°PlantUMLæœåŠ¡å™¨

**ä¼˜ç‚¹**:
- å®Œå…¨ä¸éœ€è¦Java
- åŠŸèƒ½å®Œæ•´

**ç¼ºç‚¹**:
- éœ€è¦ç½‘ç»œè¿æ¥ï¼ˆåœ¨çº¿æœåŠ¡ï¼‰
- æˆ–éœ€è¦è¿è¡ŒæœåŠ¡å™¨è¿›ç¨‹ï¼ˆæœ¬åœ°æœåŠ¡ï¼‰
- ä¸æ˜¯çœŸæ­£çš„"çº¯Node"é›†æˆ

#### æ–¹æ¡ˆ4: ç­‰å¾…æ›´å¥½çš„å·¥å…·ï¼ˆé•¿æœŸï¼‰

- ç­‰å¾…Bytecoder/TeaVMæ”¯æŒæ›´å¤šJavaç‰¹æ€§
- æˆ–ç­‰å¾…æ–°çš„Javaåˆ°Wasmç¼–è¯‘å·¥å…·

### æ¨èè¡ŒåŠ¨è®¡åˆ’

#### é˜¶æ®µ1: æ¸…ç†ï¼ˆç«‹å³ï¼‰

1. **åˆ é™¤åºŸå¼ƒä»£ç **:
   ```bash
   # åˆ é™¤æ–‡ä»¶
   rm lib/plantuml-executor-wasm.js
   rm scripts/build-plantuml-wasm.js
   rm scripts/build-wasm-maven.js
   rm scripts/build-plantuml-cheerpj.js
   rm test/wasm-executor-test.js
   rm pom.xml
   
   # åˆ é™¤åºŸå¼ƒæ–‡æ¡£ï¼ˆä¿ç•™WASM_BUILD_LIMITATIONS.mdä½œä¸ºè¯´æ˜ï¼‰
   rm docs/WASM_IMPLEMENTATION.md
   rm docs/WASM_BUILD_ARCHITECTURE.md
   rm docs/WASM_INTEGRATION.md
   rm docs/README_WASM.md
   rm docs/PURE_NODE_IMPLEMENTATION.md
   rm docs/ROADMAP_PURE_NODE.md
   ```

2. **ç®€åŒ– plantuml-executor.js**:
   - åˆ é™¤Wasmå°è¯•é€»è¾‘ï¼ˆç¬¬86-132è¡Œï¼‰
   - åˆ é™¤ `useWasm()` å‡½æ•°ï¼ˆç¬¬64-74è¡Œï¼‰
   - ç›´æ¥ä½¿ç”¨Javaæ‰§è¡Œå™¨

3. **æ›´æ–° package.json**:
   - åˆ é™¤Wasmç›¸å…³è„šæœ¬
   - åˆ é™¤ `files` ä¸­çš„Wasmæ–‡ä»¶å¼•ç”¨

4. **æ›´æ–° README.md**:
   - ç§»é™¤"Pure Node.js"å£°æ˜
   - æ˜ç¡®è¯´æ˜éœ€è¦Javaç¯å¢ƒ
   - è¯´æ˜Nailgunä½œä¸ºæ€§èƒ½ä¼˜åŒ–é€‰é¡¹

#### é˜¶æ®µ2: æ¢ç´¢CheerpJï¼ˆå¯é€‰ï¼‰

1. æ·±å…¥ç ”ç©¶ `plantuml-core` é¡¹ç›®
2. æµ‹è¯•CheerpJåœ¨Node.jsä¸­çš„è¿è¡Œ
3. å¦‚æœå¯è¡Œï¼Œå®ç°CheerpJé›†æˆ

#### é˜¶æ®µ3: æ–‡æ¡£æ›´æ–°

1. æ›´æ–°æ‰€æœ‰æ–‡æ¡£ï¼Œåæ˜ å®é™…æ¶æ„
2. æ·»åŠ "ä¸ºä»€ä¹ˆéœ€è¦Java"çš„è¯´æ˜
3. æ·»åŠ è¿ç§»å†å²æ–‡æ¡£ï¼ˆè¯´æ˜ä¸ºä»€ä¹ˆWasmæ–¹æ¡ˆå¤±è´¥ï¼‰

---

## æ€»ç»“

### å½“å‰æ¶æ„
- âœ… **å·¥ä½œçš„éƒ¨åˆ†**: Javaæ‰§è¡Œå™¨ï¼ˆspawn/Nailgunï¼‰
- âŒ **åºŸå¼ƒçš„éƒ¨åˆ†**: æ‰€æœ‰Wasmç›¸å…³ä»£ç 
- ğŸ”§ **éœ€è¦æ¸…ç†**: Wasmå°è¯•é€»è¾‘ã€åºŸå¼ƒè„šæœ¬å’Œæ–‡æ¡£

### å»ºè®®
1. **ç«‹å³æ¸…ç†**: åˆ é™¤æ‰€æœ‰Wasmç›¸å…³ä»£ç ï¼Œç®€åŒ–æ¶æ„
2. **æ˜ç¡®æ–‡æ¡£**: è¯´æ˜éœ€è¦Javaç¯å¢ƒï¼Œé¿å…è¯¯å¯¼ç”¨æˆ·
3. **ä¿æŒç¨³å®š**: Javaæ‰§è¡Œå™¨å·¥ä½œè‰¯å¥½ï¼Œä½œä¸ºä¸»è¦æ–¹æ¡ˆ
4. **æœªæ¥æ¢ç´¢**: å¦‚æœç¡®å®éœ€è¦çº¯Nodeï¼Œé‡ç‚¹ç ”ç©¶CheerpJæ–¹æ¡ˆ

### ä»£ç ç»Ÿè®¡

| ç±»å‹ | æ–‡ä»¶æ•° | è¡Œæ•°ä¼°è®¡ | çŠ¶æ€ |
|------|--------|----------|------|
| Wasmæ‰§è¡Œå™¨ | 1 | ~330 | ğŸ”´ åºŸå¼ƒ |
| Wasmæ„å»ºè„šæœ¬ | 3 | ~1330 | ğŸ”´ åºŸå¼ƒ |
| Wasmæ–‡æ¡£ | 6 | ~1000+ | ğŸ”´ åºŸå¼ƒ |
| Javaæ‰§è¡Œå™¨ | æ ¸å¿ƒä»£ç  | ~100 | âœ… ä¿ç•™ |
| ä¸»æ¨¡å— | 1 | ~450 | âœ… ä¿ç•™ |

**åºŸå¼ƒä»£ç æ€»è®¡**: çº¦2600+è¡Œä»£ç å’Œæ–‡æ¡£éœ€è¦æ¸…ç†

