name: Test External Installation

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test-external-install:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18.x, 20.x]
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      # Install Java (required for PlantUML)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Install Graphviz based on platform
      - name: Install Graphviz (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
          dot -V

      - name: Install Graphviz (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "ðŸ“¦ Installing Graphviz via Homebrew..."
          if ! command -v brew &> /dev/null; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          
          if [ -f /opt/homebrew/bin/brew ]; then
            echo "/opt/homebrew/bin" >> $GITHUB_PATH
          fi
          
          brew install graphviz || brew upgrade graphviz
          dot -V

      - name: Install Graphviz (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          Write-Host "Installing Graphviz via Chocolatey..."
          if (Get-Command choco -ErrorAction SilentlyContinue) {
            choco install graphviz -y
          } elseif (Get-Command winget -ErrorAction SilentlyContinue) {
            winget install Graphviz.Graphviz --accept-package-agreements --accept-source-agreements
          } else {
            Write-Host "Warning: Neither Chocolatey nor Winget found"
          }
          
          $dotPath = Get-Command dot -ErrorAction SilentlyContinue
          if ($dotPath) {
            Write-Host "Graphviz found at: $($dotPath.Source)"
            & $dotPath.Source -V
          }

      # Build the package locally (prepare for local installation)
      - name: Install dependencies for build (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Install dependencies for build (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          if (Test-Path package-lock.json) {
            npm ci
          } else {
            npm install
          }

      - name: Download PlantUML JAR
        run: npm run build:all:jar-only || echo "JAR download failed, continuing..."

      - name: Build package
        run: npm run build || echo "No build script found, skipping"

      # Create a temporary external project directory
      - name: Create external test project (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p /tmp/external-test-project
          cd /tmp/external-test-project
          npm init -y
          echo "Created test project at: $(pwd)"

      - name: Create external test project (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path $env:TEMP\external-test-project | Out-Null
          Set-Location $env:TEMP\external-test-project
          npm init -y
          Write-Host "Created test project at: $(Get-Location)"

      # Install node-plantuml-2 from local path
      - name: Install node-plantuml-2 from local path (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd /tmp/external-test-project
          npm install ${{ github.workspace }} --save
          echo "Installed node-plantuml-2 from local path"

      - name: Install node-plantuml-2 from local path (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          Set-Location $env:TEMP\external-test-project
          npm install "${{ github.workspace }}" --save
          Write-Host "Installed node-plantuml-2 from local path"

      # Verify installation
      - name: Verify installation (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd /tmp/external-test-project
          echo "=== Package.json ==="
          cat package.json
          echo ""
          echo "=== Installed packages ==="
          npm list node-plantuml-2 || echo "Package not found in list"
          echo ""
          echo "=== Node modules ==="
          ls -la node_modules/node-plantuml-2/ || echo "node_modules/node-plantuml-2 not found"

      - name: Verify installation (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          Set-Location $env:TEMP\external-test-project
          Write-Host "=== Package.json ==="
          Get-Content package.json
          Write-Host ""
          Write-Host "=== Installed packages ==="
          npm list node-plantuml-2
          Write-Host ""
          Write-Host "=== Node modules ==="
          if (Test-Path "node_modules\node-plantuml-2") {
            Get-ChildItem "node_modules\node-plantuml-2"
          } else {
            Write-Host "node_modules\node-plantuml-2 not found"
          }

      # Create test script with image validation
      - name: Create test script (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd /tmp/external-test-project
          mkdir -p test-output
          cat > test-install.js << 'EOF'
          #!/usr/bin/env node
          'use strict'
          
          var fs = require('fs')
          var path = require('path')
          
          console.log('=== Testing node-plantuml-2 Installation ===')
          console.log('')
          
          var testResults = []
          var outputDir = path.join(__dirname, 'test-output')
          
          function logTest(name, passed, message) {
            var status = passed ? 'âœ“' : 'âœ—'
            console.log(status, name + (message ? ': ' + message : ''))
            testResults.push({ name: name, passed: passed, message: message })
          }
          
          function validateImage(buffer, minSize, testName) {
            if (buffer.length === 0) {
              logTest(testName, false, 'Empty output')
              return false
            }
            
            // Check PNG signature
            var isPng = buffer[0] === 0x89 && buffer[1] === 0x50 && buffer[2] === 0x4E && buffer[3] === 0x47
            if (!isPng) {
              logTest(testName, false, 'Invalid PNG signature')
              return false
            }
            
            // Check minimum size (very small might indicate error image, but simple diagrams can be small)
            // Lower threshold: at least 500 bytes for a valid PNG (PNG header + minimal content)
            var absoluteMinSize = 500
            if (buffer.length < absoluteMinSize) {
              logTest(testName, false, 'Image too small (' + buffer.length + ' bytes, expected at least ' + absoluteMinSize + ')')
              return false
            }
            
            // Check for common error indicators in PNG (check more of the file)
            // PlantUML error images often contain text, so check a larger portion
            var checkSize = Math.min(5000, buffer.length)
            var bufferStr = buffer.toString('utf-8', 0, checkSize)
            var errorPatterns = ['ERROR', 'Error', 'Exception', 'Cannot', 'Failed', 'syntax error', 'ParseException']
            for (var i = 0; i < errorPatterns.length; i++) {
              if (bufferStr.includes(errorPatterns[i])) {
                logTest(testName, false, 'Error message detected in image: ' + errorPatterns[i])
                return false
              }
            }
            
            // Additional validation: Check PNG structure
            // Valid PNG should have IHDR chunk after signature (bytes 12-16 should be "IHDR")
            if (buffer.length >= 16) {
              var ihdrCheck = buffer.toString('ascii', 12, 16)
              if (ihdrCheck !== 'IHDR') {
                logTest(testName, false, 'Invalid PNG structure (IHDR not found)')
                return false
              }
            }
            
            // Check if image might be an error image by looking for error patterns in readable text
            // Only check if we found error patterns, don't check printable character count
            // (PNG binary data can contain many printable characters, which is normal)
            
            logTest(testName, true, buffer.length + ' bytes, valid PNG')
            return true
          }
          
          function generateAndValidate(code, format, filename, minSize, testName) {
            return new Promise(function (resolve) {
              try {
                var plantuml = require('node-plantuml-2')
                var gen = plantuml.generate(code, { format: format })
                
                var chunks = []
                var stderrChunks = []
                var hasError = false
                
                gen.out.on('data', function (chunk) {
                  chunks.push(chunk)
                })
                
                gen.out.on('error', function (err) {
                  logTest(testName, false, 'Stream error: ' + err.message)
                  hasError = true
                  resolve(false)
                })
                
                // Capture stderr if available
                if (gen.err) {
                  gen.err.on('data', function (chunk) {
                    stderrChunks.push(chunk)
                  })
                }
                
                gen.out.on('end', function () {
                  if (hasError) {
                    resolve(false)
                    return
                  }
                  
                  var buffer = Buffer.concat(chunks)
                  var stderr = stderrChunks.length > 0 ? Buffer.concat(stderrChunks).toString() : ''
                  
                  // Check stderr for errors
                  if (stderr && (stderr.includes('ERROR') || stderr.includes('Error') || stderr.includes('Exception'))) {
                    logTest(testName, false, 'Error in stderr: ' + stderr.substring(0, 200))
                    resolve(false)
                    return
                  }
                  
                  // Validate image
                  var isValid = validateImage(buffer, minSize, testName)
                  
                  if (isValid) {
                    // Save image for inspection
                    var outputPath = path.join(outputDir, filename)
                    fs.writeFileSync(outputPath, buffer)
                    console.log('  Saved to:', outputPath)
                  }
                  
                  resolve(isValid)
                })
                
                setTimeout(function () {
                  if (chunks.length === 0 && !hasError) {
                    logTest(testName, false, 'Timeout')
                    resolve(false)
                  }
                }, 30000)
                
              } catch (err) {
                logTest(testName, false, 'Exception: ' + err.message)
                resolve(false)
              }
            })
          }
          
          try {
            var plantuml = require('node-plantuml-2')
            logTest('Module Load', true, 'Loaded successfully')
            console.log('Available methods:', Object.keys(plantuml).join(', '))
            console.log('')
            
            // Test methods exist
            if (typeof plantuml.generate === 'function') {
              logTest('generate() Method', true, 'Exists')
            } else {
              logTest('generate() Method', false, 'Not found')
              process.exit(1)
            }
            
            if (typeof plantuml.testdot === 'function') {
              logTest('testdot() Method', true, 'Exists')
            } else {
              logTest('testdot() Method', false, 'Not found')
              process.exit(1)
            }
            
            console.log('')
            console.log('=== Image Generation Tests ===')
            console.log('')
            
            // Test 1: Simple sequence diagram
            generateAndValidate(
              '@startuml\nAlice -> Bob: Hello\n@enduml',
              'png',
              'test-1-simple-sequence.png',
              500, // Minimum 500 bytes (lowered for simple diagrams)
              'Simple Sequence Diagram'
            ).then(function (result1) {
              // Test 2: Class diagram
              return generateAndValidate(
                '@startuml\nclass User {\n  -name: String\n  +getName(): String\n}\n@enduml',
                'png',
                'test-2-class-diagram.png',
                500, // Minimum 500 bytes
                'Class Diagram'
              )
            }).then(function (result2) {
            // Test 3: Activity diagram (requires Graphviz)
            return generateAndValidate(
              '@startuml\nstart\n:Hello World;\nstop\n@enduml',
              'png',
              'test-3-activity-diagram.png',
              500, // Minimum 500 bytes
              'Activity Diagram'
            )
          }).then(function (result3) {
            // Test 4: State diagram (requires Graphviz)
            return generateAndValidate(
              '@startuml\n[*] --> State1\nState1 --> State2\nState2 --> [*]\n@enduml',
              'png',
              'test-4-state-diagram.png',
              500,
              'State Diagram'
            )
          }).then(function (result4) {
            // Test 5: Component diagram with dependencies (requires Graphviz)
            return generateAndValidate(
              '@startuml\ncomponent Component1\ncomponent Component2\nComponent1 --> Component2\n@enduml',
              'png',
              'test-5-component-diagram.png',
              500,
              'Component Diagram'
            )
          }).then(function (result5) {
            // Test 6: Use case diagram (requires Graphviz)
            return generateAndValidate(
              '@startuml\nactor User\nusecase "Use Case 1" as UC1\nUser --> UC1\n@enduml',
              'png',
              'test-6-usecase-diagram.png',
              500,
              'Use Case Diagram'
            )
            }).then(function () {
              // Summary
              console.log('')
              console.log('=== Test Summary ===')
              var passed = testResults.filter(function (r) { return r.passed }).length
              var failed = testResults.filter(function (r) { return !r.passed }).length
              console.log('Passed:', passed)
              console.log('Failed:', failed)
              console.log('')
              
              if (failed > 0) {
                console.log('Failed tests:')
                testResults.forEach(function (r) {
                  if (!r.passed) {
                    console.log('  âœ—', r.name, r.message || '')
                  }
                })
                process.exit(1)
              } else {
                console.log('âœ… All tests passed!')
                process.exit(0)
              }
            }).catch(function (err) {
              console.error('âœ— Test execution error:', err.message)
              console.error(err.stack)
              process.exit(1)
            })
            
          } catch (err) {
            console.error('âœ— Error loading module:', err.message)
            console.error(err.stack)
            process.exit(1)
          }
          EOF
          chmod +x test-install.js
          echo "Created test script"

      - name: Create test script (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          Set-Location $env:TEMP\external-test-project
          New-Item -ItemType Directory -Force -Path test-output | Out-Null
          $scriptContent = @'
          #!/usr/bin/env node
          'use strict'
          
          var fs = require('fs')
          var path = require('path')
          
          console.log('=== Testing node-plantuml-2 Installation ===')
          console.log('')
          
          var testResults = []
          var outputDir = path.join(__dirname, 'test-output')
          
          function logTest(name, passed, message) {
            var status = passed ? 'âœ“' : 'âœ—'
            console.log(status, name + (message ? ': ' + message : ''))
            testResults.push({ name: name, passed: passed, message: message })
          }
          
          function validateImage(buffer, minSize, testName) {
            if (buffer.length === 0) {
              logTest(testName, false, 'Empty output')
              return false
            }
            
            // Check PNG signature
            var isPng = buffer[0] === 0x89 && buffer[1] === 0x50 && buffer[2] === 0x4E && buffer[3] === 0x47
            if (!isPng) {
              logTest(testName, false, 'Invalid PNG signature')
              return false
            }
            
            // Check minimum size (very small might indicate error image, but simple diagrams can be small)
            // Lower threshold: at least 500 bytes for a valid PNG (PNG header + minimal content)
            var absoluteMinSize = 500
            if (buffer.length < absoluteMinSize) {
              logTest(testName, false, 'Image too small (' + buffer.length + ' bytes, expected at least ' + absoluteMinSize + ')')
              return false
            }
            
            // Check for common error indicators in PNG (check more of the file)
            // PlantUML error images often contain text, so check a larger portion
            var checkSize = Math.min(5000, buffer.length)
            var bufferStr = buffer.toString('utf-8', 0, checkSize)
            var errorPatterns = ['ERROR', 'Error', 'Exception', 'Cannot', 'Failed', 'syntax error', 'ParseException']
            for (var i = 0; i < errorPatterns.length; i++) {
              if (bufferStr.includes(errorPatterns[i])) {
                logTest(testName, false, 'Error message detected in image: ' + errorPatterns[i])
                return false
              }
            }
            
            // Additional validation: Check PNG structure
            // Valid PNG should have IHDR chunk after signature (bytes 12-16 should be "IHDR")
            if (buffer.length >= 16) {
              var ihdrCheck = buffer.toString('ascii', 12, 16)
              if (ihdrCheck !== 'IHDR') {
                logTest(testName, false, 'Invalid PNG structure (IHDR not found)')
                return false
              }
            }
            
            // Check if image might be an error image by looking for error patterns in readable text
            // Only check if we found error patterns, don't check printable character count
            // (PNG binary data can contain many printable characters, which is normal)
            
            logTest(testName, true, buffer.length + ' bytes, valid PNG')
            return true
          }
          
          function generateAndValidate(code, format, filename, minSize, testName) {
            return new Promise(function (resolve) {
              try {
                var plantuml = require('node-plantuml-2')
                var gen = plantuml.generate(code, { format: format })
                
                var chunks = []
                var stderrChunks = []
                var hasError = false
                
                gen.out.on('data', function (chunk) {
                  chunks.push(chunk)
                })
                
                gen.out.on('error', function (err) {
                  logTest(testName, false, 'Stream error: ' + err.message)
                  hasError = true
                  resolve(false)
                })
                
                // Capture stderr if available
                if (gen.err) {
                  gen.err.on('data', function (chunk) {
                    stderrChunks.push(chunk)
                  })
                }
                
                gen.out.on('end', function () {
                  if (hasError) {
                    resolve(false)
                    return
                  }
                  
                  var buffer = Buffer.concat(chunks)
                  var stderr = stderrChunks.length > 0 ? Buffer.concat(stderrChunks).toString() : ''
                  
                  // Check stderr for errors
                  if (stderr && (stderr.includes('ERROR') || stderr.includes('Error') || stderr.includes('Exception'))) {
                    logTest(testName, false, 'Error in stderr: ' + stderr.substring(0, 200))
                    resolve(false)
                    return
                  }
                  
                  // Validate image
                  var isValid = validateImage(buffer, minSize, testName)
                  
                  if (isValid) {
                    // Save image for inspection
                    var outputPath = path.join(outputDir, filename)
                    fs.writeFileSync(outputPath, buffer)
                    console.log('  Saved to:', outputPath)
                  }
                  
                  resolve(isValid)
                })
                
                setTimeout(function () {
                  if (chunks.length === 0 && !hasError) {
                    logTest(testName, false, 'Timeout')
                    resolve(false)
                  }
                }, 30000)
                
              } catch (err) {
                logTest(testName, false, 'Exception: ' + err.message)
                resolve(false)
              }
            })
          }
          
          try {
            var plantuml = require('node-plantuml-2')
            logTest('Module Load', true, 'Loaded successfully')
            console.log('Available methods:', Object.keys(plantuml).join(', '))
            console.log('')
            
            // Test methods exist
            if (typeof plantuml.generate === 'function') {
              logTest('generate() Method', true, 'Exists')
            } else {
              logTest('generate() Method', false, 'Not found')
              process.exit(1)
            }
            
            if (typeof plantuml.testdot === 'function') {
              logTest('testdot() Method', true, 'Exists')
            } else {
              logTest('testdot() Method', false, 'Not found')
              process.exit(1)
            }
            
            console.log('')
            console.log('=== Image Generation Tests ===')
            console.log('')
            
            // Test 1: Simple sequence diagram
            generateAndValidate(
              '@startuml\nAlice -> Bob: Hello\n@enduml',
              'png',
              'test-1-simple-sequence.png',
              500, // Minimum 500 bytes (lowered for simple diagrams)
              'Simple Sequence Diagram'
            ).then(function (result1) {
              // Test 2: Class diagram
              return generateAndValidate(
                '@startuml\nclass User {\n  -name: String\n  +getName(): String\n}\n@enduml',
                'png',
                'test-2-class-diagram.png',
                500, // Minimum 500 bytes
                'Class Diagram'
              )
            }).then(function (result2) {
            // Test 3: Activity diagram (requires Graphviz)
            return generateAndValidate(
              '@startuml\nstart\n:Hello World;\nstop\n@enduml',
              'png',
              'test-3-activity-diagram.png',
              500, // Minimum 500 bytes
              'Activity Diagram'
            )
          }).then(function (result3) {
            // Test 4: State diagram (requires Graphviz)
            return generateAndValidate(
              '@startuml\n[*] --> State1\nState1 --> State2\nState2 --> [*]\n@enduml',
              'png',
              'test-4-state-diagram.png',
              500,
              'State Diagram'
            )
          }).then(function (result4) {
            // Test 5: Component diagram with dependencies (requires Graphviz)
            return generateAndValidate(
              '@startuml\ncomponent Component1\ncomponent Component2\nComponent1 --> Component2\n@enduml',
              'png',
              'test-5-component-diagram.png',
              500,
              'Component Diagram'
            )
          }).then(function (result5) {
            // Test 6: Use case diagram (requires Graphviz)
            return generateAndValidate(
              '@startuml\nactor User\nusecase "Use Case 1" as UC1\nUser --> UC1\n@enduml',
              'png',
              'test-6-usecase-diagram.png',
              500,
              'Use Case Diagram'
            )
            }).then(function () {
              // Summary
              console.log('')
              console.log('=== Test Summary ===')
              var passed = testResults.filter(function (r) { return r.passed }).length
              var failed = testResults.filter(function (r) { return !r.passed }).length
              console.log('Passed:', passed)
              console.log('Failed:', failed)
              console.log('')
              
              if (failed > 0) {
                console.log('Failed tests:')
                testResults.forEach(function (r) {
                  if (!r.passed) {
                    console.log('  âœ—', r.name, r.message || '')
                  }
                })
                process.exit(1)
              } else {
                console.log('âœ… All tests passed!')
                process.exit(0)
              }
            }).catch(function (err) {
              console.error('âœ— Test execution error:', err.message)
              console.error(err.stack)
              process.exit(1)
            })
            
          } catch (err) {
            console.error('âœ— Error loading module:', err.message)
            console.error(err.stack)
            process.exit(1)
          }
          '@
          # Use UTF8NoBOM encoding to avoid BOM issues
          $utf8NoBom = New-Object System.Text.UTF8Encoding $false
          [System.IO.File]::WriteAllText("$PWD\test-install.js", $scriptContent, $utf8NoBom)
          Write-Host "Created test script"

      # Run the test
      - name: Run installation test (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd /tmp/external-test-project
          node test-install.js

      - name: Verify Graphviz before test (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          Write-Host "=== Verifying Graphviz Installation ==="
          $dotPath = Get-Command dot -ErrorAction SilentlyContinue
          if ($dotPath) {
            Write-Host "Graphviz found at: $($dotPath.Source)"
            Write-Host "Testing dot command..."
            try {
              # Graphviz -V outputs to stderr, so we need to handle it properly
              $versionOutput = & $dotPath.Source -V 2>&1 | Out-String
              Write-Host "Version output: $versionOutput"
              Write-Host "[OK] Graphviz version check passed"
            } catch {
              Write-Host "[WARN] Could not get Graphviz version: $_"
            }
            
            # Test if dot can generate output
            Write-Host "Testing dot with simple graph..."
            $testGraph = "digraph G { A -> B }"
            try {
              $testOutput = $testGraph | & $dotPath.Source -Tpng 2>&1 | Out-String
              if ($LASTEXITCODE -eq 0 -or $testOutput.Length -gt 0) {
                Write-Host "[OK] Graphviz dot command works correctly"
              } else {
                Write-Host "[FAIL] Graphviz dot command failed (exit code: $LASTEXITCODE)"
                Write-Host "Error: $testOutput"
              }
            } catch {
              Write-Host "[FAIL] Graphviz dot command failed with exception: $_"
            }
          } else {
            Write-Host "[WARN] Graphviz not found in PATH"
          }

      - name: Run installation test (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          Set-Location $env:TEMP\external-test-project
          Write-Host "=== Running installation test ==="
          # Verify Graphviz is accessible
          $dotPath = Get-Command dot -ErrorAction SilentlyContinue
          if ($dotPath) {
            Write-Host "Graphviz available at: $($dotPath.Source)"
          }
          node test-install.js

      # Additional comprehensive test
      - name: Run comprehensive integration test (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd /tmp/external-test-project
          node -e "
          var plantuml = require('node-plantuml-2');
          var javaResolver = require('node-plantuml-2/lib/java-resolver');
          var dotResolver = require('node-plantuml-2/lib/dot-resolver');
          
          console.log('=== Comprehensive Integration Test ===');
          console.log('');
          
          // Test JRE detection
          var javaPath = javaResolver.resolveJavaExecutable({});
          console.log('JRE:', javaPath || 'NOT FOUND');
          
          // Test Graphviz detection
          var dotPath = dotResolver.resolveDotExecutable({ dotPath: null });
          console.log('Graphviz:', dotPath || 'NOT FOUND');
          
          // Test testdot
          plantuml.testdot(function(isOk) {
            console.log('testdot:', isOk ? 'OK' : 'FAILED');
            process.exit(isOk ? 0 : 1);
          });
          "

      - name: Run comprehensive integration test (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          Set-Location $env:TEMP\external-test-project
          node -e "var plantuml = require('node-plantuml-2'); var javaResolver = require('node-plantuml-2/lib/java-resolver'); var dotResolver = require('node-plantuml-2/lib/dot-resolver'); console.log('=== Comprehensive Integration Test ==='); console.log(''); var javaPath = javaResolver.resolveJavaExecutable({}); console.log('JRE:', javaPath || 'NOT FOUND'); var dotPath = dotResolver.resolveDotExecutable({ dotPath: null }); console.log('Graphviz:', dotPath || 'NOT FOUND'); plantuml.testdot(function(isOk) { console.log('testdot:', isOk ? 'OK' : 'FAILED'); process.exit(isOk ? 0 : 1); });"

      # Upload generated images as artifacts for manual inspection
      - name: Prepare images for upload (Windows)
        if: runner.os == 'Windows' && always()
        shell: powershell
        run: |
          $sourcePath = "$env:TEMP\external-test-project\test-output"
          $destPath = "${{ github.workspace }}\test-images"
          New-Item -ItemType Directory -Force -Path $destPath | Out-Null
          if (Test-Path $sourcePath) {
            Copy-Item "$sourcePath\*.png" -Destination $destPath -ErrorAction SilentlyContinue
            Write-Host "Copied images to workspace for upload"
            Get-ChildItem $destPath -Filter *.png | ForEach-Object { Write-Host "  - $($_.Name) ($($_.Length) bytes)" }
          } else {
            Write-Host "No test-output directory found"
          }

      - name: Upload test images artifact (Windows)
        if: runner.os == 'Windows' && always()
        uses: actions/upload-artifact@v4
        with:
          name: test-images-${{ matrix.os }}-node${{ matrix.node-version }}
          path: test-images/*.png
          if-no-files-found: ignore
          retention-days: 7

      - name: Prepare images for upload (Unix)
        if: runner.os != 'Windows' && always()
        shell: bash
        run: |
          mkdir -p ${{ github.workspace }}/test-images
          if [ -d /tmp/external-test-project/test-output ]; then
            cp /tmp/external-test-project/test-output/*.png ${{ github.workspace }}/test-images/ 2>/dev/null || true
            echo "Copied images to workspace for upload"
            ls -lh ${{ github.workspace }}/test-images/*.png 2>/dev/null || echo "No images found"
          fi

      - name: Upload test images artifact (Unix)
        if: runner.os != 'Windows' && always()
        uses: actions/upload-artifact@v4
        with:
          name: test-images-${{ matrix.os }}-node${{ matrix.node-version }}
          path: test-images/*.png
          if-no-files-found: ignore
          retention-days: 7

