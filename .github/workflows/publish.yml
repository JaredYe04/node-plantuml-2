name: Publish to npm

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (patch, minor, major)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version-dispatch.outputs.version || steps.version-release.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync with remote (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "üîÑ Fetching latest changes from remote..."
          DEFAULT_BRANCH=$(git remote show origin | grep "HEAD branch" | cut -d" " -f5 || echo "")
          if [ -z "$DEFAULT_BRANCH" ]; then
            for branch in main master; do
              if git ls-remote --heads origin $branch | grep -q .; then
                DEFAULT_BRANCH=$branch
                break
              fi
            done
          fi
          if [ -z "$DEFAULT_BRANCH" ]; then
            DEFAULT_BRANCH="main"
          fi
          echo "üîÑ Using branch: $DEFAULT_BRANCH"
          git fetch origin $DEFAULT_BRANCH || true
          CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "")
          if [ -z "$CURRENT_BRANCH" ] || [ "$CURRENT_BRANCH" != "$DEFAULT_BRANCH" ]; then
            git checkout $DEFAULT_BRANCH || true
          fi
          git pull origin $DEFAULT_BRANCH --rebase || git pull origin $DEFAULT_BRANCH || true

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Bump version (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        id: version-dispatch
        shell: bash
        run: |
          LOCAL_VERSION=$(node -p "require('./package.json').version")
          echo "üì¶ Local package.json version: $LOCAL_VERSION"

          NPM_VERSION=$(npm view node-plantuml-2 version 2>/dev/null || echo "")

          if [ -z "$NPM_VERSION" ]; then
            echo "üì¶ No existing version on npm, starting fresh"
            BASE_VERSION=$LOCAL_VERSION
          else
            echo "üì¶ Latest npm version: $NPM_VERSION"

            COMPARE=$(node -e "
              const local = '$LOCAL_VERSION'.split('.').map(Number);
              const npm = '$NPM_VERSION'.split('.').map(Number);
              for (let i = 0; i < 3; i++) {
                if (local[i] > npm[i]) {
                  console.log('local');
                  process.exit(0);
                } else if (local[i] < npm[i]) {
                  console.log('npm');
                  process.exit(0);
                }
              }
              console.log('equal');
            ")

            if [ "$COMPARE" = "npm" ] || [ "$COMPARE" = "equal" ]; then
              echo "‚ö†Ô∏è  npm version ($NPM_VERSION) is newer or equal to local ($LOCAL_VERSION)"
              npm version $NPM_VERSION --no-git-tag-version --allow-same-version
              BASE_VERSION=$NPM_VERSION
            else
              echo "‚úÖ Local version ($LOCAL_VERSION) is newer than npm ($NPM_VERSION)"
              BASE_VERSION=$LOCAL_VERSION
            fi
          fi

          CURRENT=$(node -p "require('./package.json').version")
          if [ "$CURRENT" != "$BASE_VERSION" ]; then
            npm version $BASE_VERSION --no-git-tag-version --allow-same-version
          fi

          echo "üÜï Incrementing version (${{ github.event.inputs.version }})..."
          npm version ${{ github.event.inputs.version }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "üÜï New version: $NEW_VERSION"

          if npm view node-plantuml-2@$NEW_VERSION version > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Version $NEW_VERSION already exists, incrementing again..."
            npm version ${{ github.event.inputs.version }} --no-git-tag-version
            NEW_VERSION=$(node -p "require('./package.json').version")

            if npm view node-plantuml-2@$NEW_VERSION version > /dev/null 2>&1; then
              echo "‚ùå Error: Version $NEW_VERSION also exists on npm"
              exit 1
            fi
          fi

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Bump version (release)
        if: github.event_name == 'release'
        id: version-release
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Release version: $VERSION"

          if npm view node-plantuml-2@$VERSION version > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Warning: Version $VERSION already exists on npm"
          fi

          npm version $VERSION --no-git-tag-version --allow-same-version
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "‚úÖ Version set: $VERSION"

      - name: Verify version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "üì¶ Version to publish: $VERSION"
          echo "‚úÖ Version ready"

  build-and-publish-runtimes:
    needs: prepare
    strategy:
      matrix:
        include:
          - platform: linux
            arch: x64
            runner: ubuntu-latest
            package: '@node-plantuml-2/jre-linux-x64'
          - platform: win32
            arch: x64
            runner: windows-latest
            package: '@node-plantuml-2/jre-win32-x64'
          - platform: darwin
            arch: x64
            runner: macos-12
            package: '@node-plantuml-2/jre-darwin-x64'
          - platform: darwin
            arch: arm64
            runner: macos-14
            package: '@node-plantuml-2/jre-darwin-arm64'
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Verify Java installation
        shell: bash
        run: |
          java -version
          jlink --version

      - name: Install dependencies
        shell: bash
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Download PlantUML JAR
        shell: bash
        run: |
          echo "üì• Downloading PlantUML JAR..."
          node scripts/get-plantuml-jar.js --latest || echo "JAR download failed, but continuing..."

      - name: Create runtime directory
        shell: bash
        run: |
          mkdir -p runtimes/@node-plantuml-2/jre-${{ matrix.platform }}-${{ matrix.arch }}

      - name: Create package.json for runtime
        shell: bash
        run: |
          echo "üìù Creating package.json for ${{ matrix.package }}..."
          node scripts/create-runtime-package-json.js ${{ matrix.platform }} ${{ matrix.arch }} ${{ needs.prepare.outputs.version }}

      - name: Build JRE
        shell: bash
        run: |
          echo "üî® Building JRE for ${{ matrix.platform }} ${{ matrix.arch }}..."
          node scripts/build-jre.js ${{ matrix.platform }} ${{ matrix.arch }}

      - name: Verify JRE
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "win32" ]; then
            JAVA_EXE="runtimes/@node-plantuml-2/jre-${{ matrix.platform }}-${{ matrix.arch }}/jre/bin/java.exe"
          else
            JAVA_EXE="runtimes/@node-plantuml-2/jre-${{ matrix.platform }}-${{ matrix.arch }}/jre/bin/java"
          fi
          
          if [ ! -f "$JAVA_EXE" ]; then
            echo "‚ùå Error: JRE executable not found at $JAVA_EXE"
            exit 1
          fi
          
          echo "‚úì JRE executable found"
          
          # Verify Java works
          if [ "${{ matrix.platform }}" = "win32" ]; then
            "$JAVA_EXE" -version
          else
            chmod +x "$JAVA_EXE"
            "$JAVA_EXE" -version
          fi
          
          echo "‚úÖ JRE verification passed"

      - name: Test JRE with PlantUML
        shell: bash
        continue-on-error: true
        run: |
          echo "üß™ Testing JRE with PlantUML..."
          if [ "${{ matrix.platform }}" = "win32" ]; then
            JAVA_EXE="runtimes/@node-plantuml-2/jre-${{ matrix.platform }}-${{ matrix.arch }}/jre/bin/java.exe"
            PLANTUML_JAR="vendor/plantuml.jar"
            TEST_CODE="@startuml
            A -> B
            @enduml"
            
            echo "$TEST_CODE" | "$JAVA_EXE" -Djava.awt.headless=true -jar "$PLANTUML_JAR" -pipe -tpng > test-output.png || {
              echo "‚ö†Ô∏è  PlantUML test failed, but continuing..."
              exit 0
            }
            
            if [ -f test-output.png ] && [ -s test-output.png ]; then
              echo "‚úì PlantUML test passed ($(wc -c < test-output.png) bytes)"
              rm -f test-output.png
            else
              echo "‚ö†Ô∏è  PlantUML test output is empty, but continuing..."
            fi
          else
            JAVA_EXE="runtimes/@node-plantuml-2/jre-${{ matrix.platform }}-${{ matrix.arch }}/jre/bin/java"
            PLANTUML_JAR="vendor/plantuml.jar"
            TEST_CODE="@startuml
            A -> B
            @enduml"
            
            chmod +x "$JAVA_EXE"
            echo "$TEST_CODE" | "$JAVA_EXE" -Djava.awt.headless=true -jar "$PLANTUML_JAR" -pipe -tpng > test-output.png || {
              echo "‚ö†Ô∏è  PlantUML test failed, but continuing..."
              exit 0
            }
            
            if [ -f test-output.png ] && [ -s test-output.png ]; then
              echo "‚úì PlantUML test passed ($(wc -c < test-output.png) bytes)"
              rm -f test-output.png
            else
              echo "‚ö†Ô∏è  PlantUML test output is empty, but continuing..."
            fi
          fi

      - name: Verify NPM authentication
        shell: bash
        run: |
          echo "üîç Verifying npm authentication..."
          npm whoami || {
            echo "‚ùå Error: Not authenticated to npm"
            exit 1
          }
          echo "‚úÖ Successfully authenticated to npm"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Check if runtime package version exists
        id: check-version
        shell: bash
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          if npm view ${{ matrix.package }}@$VERSION version > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Version $VERSION already exists for ${{ matrix.package }}"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Version $VERSION is available for ${{ matrix.package }}"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

      - name: Publish runtime package
        if: steps.check-version.outputs.exists != 'true'
        shell: bash
        run: |
          echo "üì¶ Publishing ${{ matrix.package }}@${{ needs.prepare.outputs.version }}..."
          cd runtimes/@node-plantuml-2/jre-${{ matrix.platform }}-${{ matrix.arch }}
          npm publish --access public
          echo "‚úÖ Published ${{ matrix.package }}@${{ needs.prepare.outputs.version }}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish runtime package (skip if exists)
        if: steps.check-version.outputs.exists == 'true'
        shell: bash
        run: |
          echo "‚ÑπÔ∏è  Version ${{ needs.prepare.outputs.version }} already exists for ${{ matrix.package }}, skipping publish"

  publish-main:
    needs: [prepare, build-and-publish-runtimes]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          ref: ${{ github.event.release.tag_name || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Update version and optionalDependencies
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "üì¶ Updating main package to version $VERSION"
          
          # Update version
          npm version $VERSION --no-git-tag-version --allow-same-version
          
          # Update optionalDependencies to match runtime package versions
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            const version = '$VERSION';
            
            pkg.optionalDependencies = {
              '@node-plantuml-2/jre-win32-x64': '^' + version,
              '@node-plantuml-2/jre-darwin-arm64': '^' + version,
              '@node-plantuml-2/jre-darwin-x64': '^' + version,
              '@node-plantuml-2/jre-linux-x64': '^' + version
            };
            
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            console.log('‚úÖ Updated optionalDependencies to version ' + version);
          "

      - name: Download PlantUML JAR
        run: |
          echo "üì• Downloading latest PlantUML JAR..."
          node scripts/get-plantuml-jar.js --latest || echo "JAR download failed, but continuing..."

      - name: Verify NPM authentication
        run: |
          echo "üîç Verifying npm authentication..."
          npm whoami || {
            echo "‚ùå Error: Not authenticated to npm"
            exit 1
          }
          echo "‚úÖ Successfully authenticated to npm"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify version before publish
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "üì¶ Preparing to publish main package version: $VERSION"

          if npm view node-plantuml-2@$VERSION version > /dev/null 2>&1; then
            echo "‚ùå Error: Version $VERSION already exists on npm registry"
            exit 1
          fi

          echo "‚úÖ Version $VERSION is ready to publish"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish main package
        run: |
          echo "üì¶ Publishing main package to npm..."
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: false

      - name: Create Git tag and push (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          # Add package.json and lock files if they exist
          git add package.json
          [ -f package-lock.json ] && git add package-lock.json || true
          [ -f yarn.lock ] && git add yarn.lock || true
          [ -f pnpm-lock.yaml ] && git add pnpm-lock.yaml || true

          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è  No changes to commit"
          else
            git commit -m "chore: bump version to $VERSION" || echo "Nothing to commit"
          fi

          echo "üîÑ Pulling latest changes from remote..."
          DEFAULT_BRANCH=$(git remote show origin | grep "HEAD branch" | cut -d" " -f5 || echo "")
          if [ -z "$DEFAULT_BRANCH" ]; then
            for branch in main master; do
              if git ls-remote --heads origin $branch | grep -q .; then
                DEFAULT_BRANCH=$branch
                break
              fi
            done
          fi
          if [ -z "$DEFAULT_BRANCH" ]; then
            DEFAULT_BRANCH="main"
          fi
          echo "üîÑ Using branch: $DEFAULT_BRANCH"
          git fetch origin $DEFAULT_BRANCH || true
          git pull origin $DEFAULT_BRANCH --rebase || git pull origin $DEFAULT_BRANCH --no-edit || {
            echo "‚ö†Ô∏è  Warning: Failed to sync with remote, but continuing..."
          }

          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Tag v$VERSION already exists locally"
          else
            git tag -a "v$VERSION" -m "Release v$VERSION"
          fi

          echo "üì§ Pushing changes to remote..."
          git push origin HEAD:$DEFAULT_BRANCH || {
            echo "‚ùå Failed to push to branch: $DEFAULT_BRANCH"
            exit 1
          }

          if git ls-remote --tags origin | grep -q "refs/tags/v$VERSION$"; then
            echo "‚ÑπÔ∏è  Tag v$VERSION already exists on remote"
          else
            git push origin "v$VERSION" || {
              echo "‚ö†Ô∏è  Failed to push tag, but code was pushed successfully"
            }
          fi

          echo "‚úÖ Successfully pushed version $VERSION"

      - name: Create GitHub Release (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: Release v${{ needs.prepare.outputs.version }}
          body: |
            ## Changes in v${{ needs.prepare.outputs.version }}

            See [CHANGELOG.md](CHANGELOG.md) for details.

            ### ‚ú® Features
            - Bundled JRE support (no Java installation required)
            - Multiple output formats (PNG, SVG, EPS, ASCII, Unicode)
            - Full UTF-8 and Chinese character support
            - Platform-specific JRE runtime packages
          draft: false
          prerelease: false
