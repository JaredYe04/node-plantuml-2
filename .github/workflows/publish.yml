name: Publish to npm

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (patch, minor, major)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version-dispatch.outputs.version || steps.version-release.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync with remote (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "üîÑ Fetching latest changes from remote..."
          DEFAULT_BRANCH=$(git remote show origin | grep "HEAD branch" | cut -d" " -f5 || echo "")
          if [ -z "$DEFAULT_BRANCH" ]; then
            for branch in main master; do
              if git ls-remote --heads origin $branch | grep -q .; then
                DEFAULT_BRANCH=$branch
                break
              fi
            done
          fi
          if [ -z "$DEFAULT_BRANCH" ]; then
            DEFAULT_BRANCH="main"
          fi
          echo "üîÑ Using branch: $DEFAULT_BRANCH"
          git fetch origin $DEFAULT_BRANCH || true
          CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "")
          if [ -z "$CURRENT_BRANCH" ] || [ "$CURRENT_BRANCH" != "$DEFAULT_BRANCH" ]; then
            git checkout $DEFAULT_BRANCH || true
          fi
          git pull origin $DEFAULT_BRANCH --rebase || git pull origin $DEFAULT_BRANCH || true

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Bump version (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        id: version-dispatch
        shell: bash
        run: |
          LOCAL_VERSION=$(node -p "require('./package.json').version")
          echo "üì¶ Local package.json version: $LOCAL_VERSION"

          NPM_VERSION=$(npm view node-plantuml-2 version 2>/dev/null || echo "")

          if [ -z "$NPM_VERSION" ]; then
            echo "üì¶ No existing version on npm, starting fresh"
            BASE_VERSION=$LOCAL_VERSION
          else
            echo "üì¶ Latest npm version: $NPM_VERSION"

            COMPARE=$(node -e "
              const local = '$LOCAL_VERSION'.split('.').map(Number);
              const npm = '$NPM_VERSION'.split('.').map(Number);
              for (let i = 0; i < 3; i++) {
                if (local[i] > npm[i]) {
                  console.log('local');
                  process.exit(0);
                } else if (local[i] < npm[i]) {
                  console.log('npm');
                  process.exit(0);
                }
              }
              console.log('equal');
            ")

            if [ "$COMPARE" = "npm" ] || [ "$COMPARE" = "equal" ]; then
              echo "‚ö†Ô∏è  npm version ($NPM_VERSION) is newer or equal to local ($LOCAL_VERSION)"
              npm version $NPM_VERSION --no-git-tag-version --allow-same-version
              BASE_VERSION=$NPM_VERSION
            else
              echo "‚úÖ Local version ($LOCAL_VERSION) is newer than npm ($NPM_VERSION)"
              BASE_VERSION=$LOCAL_VERSION
            fi
          fi

          CURRENT=$(node -p "require('./package.json').version")
          if [ "$CURRENT" != "$BASE_VERSION" ]; then
            npm version $BASE_VERSION --no-git-tag-version --allow-same-version
          fi

          echo "üÜï Incrementing version (${{ github.event.inputs.version }})..."
          npm version ${{ github.event.inputs.version }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "üÜï New version: $NEW_VERSION"

          if npm view node-plantuml-2@$NEW_VERSION version > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Version $NEW_VERSION already exists, incrementing again..."
            npm version ${{ github.event.inputs.version }} --no-git-tag-version
            NEW_VERSION=$(node -p "require('./package.json').version")

            if npm view node-plantuml-2@$NEW_VERSION version > /dev/null 2>&1; then
              echo "‚ùå Error: Version $NEW_VERSION also exists on npm"
              exit 1
            fi
          fi

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Bump version (release)
        if: github.event_name == 'release'
        id: version-release
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Release version: $VERSION"

          if npm view node-plantuml-2@$VERSION version > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Warning: Version $VERSION already exists on npm"
          fi

          npm version $VERSION --no-git-tag-version --allow-same-version
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "‚úÖ Version set: $VERSION"

      - name: Verify version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "üì¶ Version to publish: $VERSION"
          echo "‚úÖ Version ready"

      - name: Download PlantUML JAR
        shell: bash
        run: |
          echo "üì• Downloading PlantUML JAR (will be shared with other jobs)..."
          node scripts/get-plantuml-jar.js --latest || echo "JAR download failed, but continuing..."
        continue-on-error: true

      - name: Upload PlantUML JAR as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vendor-files
          path: |
            vendor/plantuml.jar
            vendor/**
          retention-days: 1

  build-and-publish-runtimes:
    needs: prepare
    strategy:
      matrix:
        include:
          - platform: linux
            arch: x64
            runner: ubuntu-latest
            package: '@node-plantuml-2/jre-linux-x64'
          - platform: win32
            arch: x64
            runner: windows-latest
            package: '@node-plantuml-2/jre-win32-x64'
          - platform: darwin
            arch: arm64
            runner: macos-14
            package: '@node-plantuml-2/jre-darwin-arm64'
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Verify Java installation
        shell: bash
        run: |
          echo "Java version:"
          java -version
          echo ""
          echo "JAVA_HOME: $JAVA_HOME"
          echo ""
          echo "Checking jlink..."
          if [ -f "$JAVA_HOME/bin/jlink" ]; then
            echo "‚úì jlink found at: $JAVA_HOME/bin/jlink"
            "$JAVA_HOME/bin/jlink" --version
          elif command -v jlink &> /dev/null; then
            echo "‚úì jlink found in PATH"
            jlink --version
          else
            echo "‚ùå Error: jlink not found in JAVA_HOME/bin or PATH"
            exit 1
          fi

      - name: Install dependencies
        shell: bash
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Download PlantUML JAR from artifact
        id: download-vendor
        uses: actions/download-artifact@v4
        if: always()
        with:
          name: vendor-files
          path: vendor/
          merge-multiple: true

      - name: Download PlantUML JAR (fallback if artifact missing)
        shell: bash
        if: steps.download-vendor.outcome == 'failure'
        run: |
          echo "üì• Artifact not available - Downloading PlantUML JAR (fallback)..."
          node scripts/get-plantuml-jar.js --latest || echo "JAR download failed, but continuing..."
        continue-on-error: true

      - name: Verify PlantUML JAR exists
        shell: bash
        run: |
          if [ ! -f "vendor/plantuml.jar" ]; then
            echo "üì• PlantUML JAR not found - Downloading..."
            node scripts/get-plantuml-jar.js --latest || echo "JAR download failed, but continuing..."
          else
            echo "‚úì PlantUML JAR found"
          fi
        continue-on-error: true

      - name: Create runtime directory
        shell: bash
        run: |
          mkdir -p runtimes/@node-plantuml-2/jre-${{ matrix.platform }}-${{ matrix.arch }}

      - name: Create package.json for runtime
        shell: bash
        run: |
          echo "üìù Creating package.json for ${{ matrix.package }}..."
          node scripts/create-runtime-package-json.js ${{ matrix.platform }} ${{ matrix.arch }} ${{ needs.prepare.outputs.version }}

      - name: Build JRE
        shell: bash
        run: |
          echo "üî® Building JRE for ${{ matrix.platform }} ${{ matrix.arch }}..."
          echo "JAVA_HOME: $JAVA_HOME"
          # Ensure JAVA_HOME is available for the Node.js script
          export JAVA_HOME="$JAVA_HOME"
          node scripts/build-jre.js ${{ matrix.platform }} ${{ matrix.arch }}

      - name: Verify JRE
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "win32" ]; then
            JAVA_EXE="runtimes/@node-plantuml-2/jre-${{ matrix.platform }}-${{ matrix.arch }}/jre/bin/java.exe"
          else
            JAVA_EXE="runtimes/@node-plantuml-2/jre-${{ matrix.platform }}-${{ matrix.arch }}/jre/bin/java"
          fi
          
          if [ ! -f "$JAVA_EXE" ]; then
            echo "‚ùå Error: JRE executable not found at $JAVA_EXE"
            exit 1
          fi
          
          echo "‚úì JRE executable found"
          
          # Verify Java works
          if [ "${{ matrix.platform }}" = "win32" ]; then
            "$JAVA_EXE" -version
          else
            chmod +x "$JAVA_EXE"
            "$JAVA_EXE" -version
          fi
          
          echo "‚úÖ JRE verification passed"

      - name: Test JRE with PlantUML
        shell: bash
        continue-on-error: true
        run: |
          echo "üß™ Testing JRE with PlantUML..."
          if [ "${{ matrix.platform }}" = "win32" ]; then
            JAVA_EXE="runtimes/@node-plantuml-2/jre-${{ matrix.platform }}-${{ matrix.arch }}/jre/bin/java.exe"
            PLANTUML_JAR="vendor/plantuml.jar"
            TEST_CODE="@startuml
            A -> B
            @enduml"
            
            echo "$TEST_CODE" | "$JAVA_EXE" -Djava.awt.headless=true -jar "$PLANTUML_JAR" -pipe -tpng > test-output.png || {
              echo "‚ö†Ô∏è  PlantUML test failed, but continuing..."
              exit 0
            }
            
            if [ -f test-output.png ] && [ -s test-output.png ]; then
              echo "‚úì PlantUML test passed ($(wc -c < test-output.png) bytes)"
              rm -f test-output.png
            else
              echo "‚ö†Ô∏è  PlantUML test output is empty, but continuing..."
            fi
          else
            JAVA_EXE="runtimes/@node-plantuml-2/jre-${{ matrix.platform }}-${{ matrix.arch }}/jre/bin/java"
            PLANTUML_JAR="vendor/plantuml.jar"
            TEST_CODE="@startuml
            A -> B
            @enduml"
            
            chmod +x "$JAVA_EXE"
            echo "$TEST_CODE" | "$JAVA_EXE" -Djava.awt.headless=true -jar "$PLANTUML_JAR" -pipe -tpng > test-output.png || {
              echo "‚ö†Ô∏è  PlantUML test failed, but continuing..."
              exit 0
            }
            
            if [ -f test-output.png ] && [ -s test-output.png ]; then
              echo "‚úì PlantUML test passed ($(wc -c < test-output.png) bytes)"
              rm -f test-output.png
            else
              echo "‚ö†Ô∏è  PlantUML test output is empty, but continuing..."
            fi
          fi

      - name: Configure npm authentication (Windows)
        if: matrix.platform == 'win32'
        shell: powershell
        run: |
          Write-Host 'Configuring npm authentication for Windows...'
          $token = '${{ secrets.NPM_TOKEN }}'
          if ([string]::IsNullOrEmpty($token)) {
            Write-Host 'Error: NODE_AUTH_TOKEN is not set'
            exit 1
          }
          
          # Method 1: Try npm config set
          Write-Host 'Attempting to configure via npm config...'
          $configKey = '//registry.npmjs.org/:_authToken'
          $result = npm config set $configKey $token 2>&1
          if ($LASTEXITCODE -eq 0) {
            Write-Host 'npm authentication configured via npm config'
          } else {
            Write-Host 'npm config failed, trying direct .npmrc write...'
            # Method 2: Write .npmrc directly
            $npmrcPath = Join-Path $env:USERPROFILE '.npmrc'
            $authLine = "//registry.npmjs.org/:_authToken=$token"
            
            # Read existing content if it exists
            $existingContent = ''
            if (Test-Path $npmrcPath) {
              $existingContent = Get-Content $npmrcPath -Raw
            }
            
            # Remove any existing auth token lines
            $lines = $existingContent -split "`n" | Where-Object { 
              $_ -notmatch '//registry\.npmjs\.org/:_authToken' 
            }
            
            # Add new auth token
            $newContent = ($lines + $authLine) -join "`n"
            if (-not $newContent.EndsWith("`n")) {
              $newContent += "`n"
            }
            
            try {
              Set-Content -Path $npmrcPath -Value $newContent -NoNewline
              Write-Host 'npm authentication configured via .npmrc file'
            } catch {
              Write-Host "Error writing .npmrc: $_"
              exit 1
            }
          }
          
          # Verify .npmrc exists and contains token
          $npmrcPath = Join-Path $env:USERPROFILE '.npmrc'
          if (Test-Path $npmrcPath) {
            $content = Get-Content $npmrcPath -Raw
            if ($content -match '_authToken') {
              Write-Host '.npmrc file verified'
            } else {
              Write-Host 'Warning: .npmrc exists but no auth token found'
            }
          } else {
            Write-Host 'Warning: .npmrc file not found'
          }
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify NPM authentication
        shell: bash
        run: |
          echo "üîç Verifying npm authentication..."
          npm whoami || {
            echo "‚ùå Error: Not authenticated to npm"
            echo "Attempting to debug..."
            if [ "${{ matrix.platform }}" = "win32" ]; then
              echo "Windows platform detected"
              echo "Checking .npmrc location..."
              if [ -f "$USERPROFILE/.npmrc" ]; then
                echo "Found .npmrc at: $USERPROFILE/.npmrc"
                echo "First few lines (sanitized):"
                head -n 3 "$USERPROFILE/.npmrc" 2>/dev/null | sed 's/_authToken=.*/_authToken=***/' || echo "Could not read .npmrc"
              else
                echo ".npmrc not found at: $USERPROFILE/.npmrc"
              fi
            else
              echo "Checking .npmrc location..."
              if [ -f "$HOME/.npmrc" ]; then
                echo "Found .npmrc at: $HOME/.npmrc"
                echo "First few lines (sanitized):"
                head -n 3 "$HOME/.npmrc" | sed 's/_authToken=.*/_authToken=***/'
              else
                echo ".npmrc not found at: $HOME/.npmrc"
              fi
            fi
            exit 1
          }
          echo "‚úÖ Successfully authenticated to npm"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Check npm organization exists
        shell: bash
        run: |
          echo "üîç Checking if npm organization @node-plantuml-2 exists..."
          
          # Try to check if the organization scope exists by attempting to view a non-existent package
          # If scope doesn't exist, npm will return "Scope not found"
          ERROR_OUTPUT=$(npm view @node-plantuml-2/jre-linux-x64@999.0.0 2>&1 || true)
          
          if echo "$ERROR_OUTPUT" | grep -q "Scope not found"; then
            echo ""
            echo "‚ùå ERROR: npm organization @node-plantuml-2 does not exist!"
            echo ""
            echo "üìù You must create the npm organization before publishing runtime packages."
            echo ""
            echo "   Quick setup (choose one method):"
            echo ""
            echo "   Method 1 (Web UI - Recommended):"
            echo "   1. Go to: https://www.npmjs.com/org/create"
            echo "   2. Create organization: node-plantuml-2"
            echo "   3. Choose 'Public' (free for public packages)"
            echo "   4. Make sure your npm account is the owner"
            echo ""
            echo "   Method 2 (Command line):"
            echo "   npm org create node-plantuml-2"
            echo ""
            echo "   After creating:"
            echo "   - Ensure your NPM_TOKEN has access to publish to the organization"
            echo "   - You may need to regenerate your NPM_TOKEN with organization permissions"
            echo ""
            echo "   For detailed instructions, see: docs/NPM_ORGANIZATION_SETUP.md"
            echo ""
            exit 1
          elif echo "$ERROR_OUTPUT" | grep -q "not in this registry\|404"; then
            # Package doesn't exist, but scope exists - this is OK
            echo "‚úÖ npm organization @node-plantuml-2 exists (package not found is expected)"
          else
            echo "‚ö†Ô∏è  Could not definitively verify organization, but continuing..."
            echo "   If publish fails with 'Scope not found', please check docs/NPM_ORGANIZATION_SETUP.md"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: false

      - name: Check if runtime package version exists
        id: check-version
        shell: bash
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          if npm view ${{ matrix.package }}@$VERSION version > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Version $VERSION already exists for ${{ matrix.package }}"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Version $VERSION is available for ${{ matrix.package }}"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

      - name: Verify JRE package
        shell: bash
        run: |
          echo "üîç Verifying JRE package before publishing..."
          # Basic verification - check Java executable exists and works
          if [ "${{ matrix.platform }}" = "win32" ]; then
            JAVA_EXE="runtimes/@node-plantuml-2/jre-${{ matrix.platform }}-${{ matrix.arch }}/jre/bin/java.exe"
          else
            JAVA_EXE="runtimes/@node-plantuml-2/jre-${{ matrix.platform }}-${{ matrix.arch }}/jre/bin/java"
          fi
          
          if [ ! -f "$JAVA_EXE" ]; then
            echo "‚ùå Error: Java executable not found"
            exit 1
          fi
          
          echo "‚úì Java executable found"
          "$JAVA_EXE" -version || {
            echo "‚ùå Error: Java executable does not work"
            exit 1
          }
          echo "‚úÖ JRE package verification passed"

      - name: Publish runtime package
        if: steps.check-version.outputs.exists != 'true'
        shell: bash
        run: |
          echo "üì¶ Publishing ${{ matrix.package }}@${{ needs.prepare.outputs.version }}..."
          node scripts/publish-runtime-package.js jre ${{ matrix.platform }} ${{ matrix.arch }} --version ${{ needs.prepare.outputs.version }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish runtime package (skip if exists)
        if: steps.check-version.outputs.exists == 'true'
        shell: bash
        run: |
          echo "‚ÑπÔ∏è  Version ${{ needs.prepare.outputs.version }} already exists for ${{ matrix.package }}, skipping publish"

  build-and-publish-graphviz:
    needs: prepare
    strategy:
      matrix:
        include:
          - platform: linux
            arch: x64
            runner: ubuntu-latest
            package: '@node-plantuml-2/graphviz-linux-x64'
          - platform: win32
            arch: x64
            runner: windows-latest
            package: '@node-plantuml-2/graphviz-win32-x64'
          - platform: darwin
            arch: arm64
            runner: macos-14
            package: '@node-plantuml-2/graphviz-darwin-arm64'
          - platform: darwin
            arch: x64
            runner: macos-14
            package: '@node-plantuml-2/graphviz-darwin-x64'
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Install Graphviz (for building package - macOS/Linux)
        if: matrix.platform != 'win32'
        shell: bash
        run: |
          echo "üì¶ Installing Graphviz for package building..."
          if [ "${{ matrix.platform }}" = "darwin" ]; then
            # macOS: Install via Homebrew
            if ! command -v brew &> /dev/null; then
              echo "Installing Homebrew..."
              /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            fi
            if [ -f /opt/homebrew/bin/brew ]; then
              export PATH="/opt/homebrew/bin:$PATH"
            fi
            brew install graphviz || brew upgrade graphviz
          elif [ "${{ matrix.platform }}" = "linux" ]; then
            # Linux: Install via apt-get
            sudo apt-get update
            sudo apt-get install -y graphviz
          fi

      - name: Install Graphviz (for building package - Windows)
        if: matrix.platform == 'win32'
        shell: powershell
        run: |
          Write-Host "üì¶ Installing Graphviz for package building on Windows..."
          $ErrorActionPreference = 'Continue'
          $installed = $false
          
          # Method 1: Try Winget first (usually more reliable)
          if (Get-Command winget -ErrorAction SilentlyContinue) {
            Write-Host "üîÑ Attempting to install Graphviz via Winget..."
            for ($i = 1; $i -le 3; $i++) {
              try {
                $null = winget install Graphviz.Graphviz --accept-package-agreements --accept-source-agreements --silent 2>&1
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "‚úÖ Graphviz installed successfully via Winget"
                  $installed = $true
                  break
                }
              } catch {
                Write-Host "‚ö†Ô∏è  Winget attempt $i failed: $_"
              }
              if (-not $installed) {
                Write-Host "‚ö†Ô∏è  Winget attempt $i failed, retrying..."
                Start-Sleep -Seconds 5
              }
            }
          }
          
          # Method 2: Try Chocolatey with retries (if Winget failed)
          if (-not $installed -and (Get-Command choco -ErrorAction SilentlyContinue)) {
            Write-Host "üîÑ Attempting to install Graphviz via Chocolatey..."
            for ($i = 1; $i -le 3; $i++) {
              try {
                # Clear Chocolatey cache to avoid stale packages
                if ($i -gt 1) {
                  Write-Host "   Clearing Chocolatey cache before retry..."
                  choco cache remove graphviz --expired -y 2>&1 | Out-Null
                }
                $output = choco install graphviz -y 2>&1
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "‚úÖ Graphviz installed successfully via Chocolatey"
                  $installed = $true
                  break
                } else {
                  Write-Host "   Chocolatey output: $output"
                }
              } catch {
                Write-Host "‚ö†Ô∏è  Chocolatey attempt $i failed: $_"
              }
              if (-not $installed) {
                Write-Host "‚ö†Ô∏è  Chocolatey attempt $i failed, retrying in 10 seconds..."
                Start-Sleep -Seconds 10
              }
            }
          }
          
          # Method 3: Direct download and install (fallback)
          if (-not $installed) {
            Write-Host "üîÑ Attempting to download and install Graphviz directly..."
            $graphvizUrl = "https://gitlab.com/api/v4/projects/4207231/packages/generic/graphviz-releases/10.0.1/windows_10_cmake_Release_graphviz-install-10.0.1-win64.exe"
            $installerPath = Join-Path $env:TEMP "graphviz-installer.exe"
            
            try {
              Write-Host "üì• Downloading Graphviz installer from $graphvizUrl..."
              Invoke-WebRequest -Uri $graphvizUrl -OutFile $installerPath -UseBasicParsing -TimeoutSec 300
              Write-Host "üì• Downloaded Graphviz installer, installing..."
              $process = Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait -NoNewWindow -PassThru
              if ($process.ExitCode -eq 0) {
                Write-Host "‚úÖ Graphviz installed successfully via direct download"
                $installed = $true
              } else {
                Write-Host "‚ö†Ô∏è  Installer exited with code $($process.ExitCode)"
              }
              Remove-Item $installerPath -ErrorAction SilentlyContinue
            } catch {
              Write-Host "‚ö†Ô∏è  Direct download failed: $_"
            }
          }
          
          if (-not $installed) {
            Write-Host "‚ùå All installation methods failed"
            Write-Host "‚ö†Ô∏è  Please install Graphviz manually on Windows"
            exit 1
          }
          
          # Verify installation
          $dotPath = Get-Command dot -ErrorAction SilentlyContinue
          if ($dotPath) {
            Write-Host "‚úÖ Graphviz verified: $($dotPath.Source)"
            & $dotPath.Source -V
          } else {
            Write-Host "‚ö†Ô∏è  Warning: Graphviz installed but 'dot' command not found in PATH"
            Write-Host "   Trying to refresh PATH..."
            $machinePath = [System.Environment]::GetEnvironmentVariable('Path', 'Machine')
            $userPath = [System.Environment]::GetEnvironmentVariable('Path', 'User')
            $env:Path = $machinePath + ';' + $userPath
            $dotPath = Get-Command dot -ErrorAction SilentlyContinue
            if ($dotPath) {
              Write-Host "‚úÖ Graphviz found after PATH refresh: $($dotPath.Source)"
            }
          }

      - name: Verify Graphviz installation
        shell: bash
        run: |
          echo "Verifying Graphviz installation..."
          if [ "${{ matrix.platform }}" = "win32" ]; then
            where dot || echo "dot not found"
            dot -V || echo "dot command failed"
          else
            which dot || echo "dot not found"
            dot -V || echo "dot command failed"
          fi

      - name: Install dependencies
        shell: bash
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Create Graphviz package directory
        shell: bash
        run: |
          mkdir -p runtimes/@node-plantuml-2/graphviz-${{ matrix.platform }}-${{ matrix.arch }}

      - name: Create package.json for Graphviz runtime
        shell: bash
        run: |
          echo "üìù Creating package.json for ${{ matrix.package }}..."
          node scripts/create-graphviz-package-json.js ${{ matrix.platform }} ${{ matrix.arch }} ${{ needs.prepare.outputs.version }}

      - name: Build Graphviz package
        shell: bash
        run: |
          echo "üî® Building Graphviz package for ${{ matrix.platform }} ${{ matrix.arch }}..."
          if node scripts/build-graphviz.js ${{ matrix.platform }} ${{ matrix.arch }}; then
            echo "‚úÖ Build step completed successfully"
          else
            echo "‚ùå Build step failed with exit code: $?"
            exit 1
          fi

      - name: List build output directory
        shell: bash
        run: |
          echo "üìÅ Listing build output directory..."
          PACKAGE_DIR="runtimes/@node-plantuml-2/graphviz-${{ matrix.platform }}-${{ matrix.arch }}"
          echo "Checking directory: $PACKAGE_DIR"
          echo "Current working directory: $(pwd)"
          echo ""
          
          if [ -d "$PACKAGE_DIR" ]; then
            echo "‚úÖ Package directory exists: $PACKAGE_DIR"
            echo "Contents of package directory:"
            ls -la "$PACKAGE_DIR" || echo "Failed to list package directory"
            echo ""
            
            if [ -d "$PACKAGE_DIR/graphviz" ]; then
              echo "‚úÖ Graphviz directory exists"
              echo "Contents of graphviz directory:"
              ls -la "$PACKAGE_DIR/graphviz" || echo "Failed to list graphviz directory"
              echo ""
              
              if [ -d "$PACKAGE_DIR/graphviz/bin" ]; then
                echo "‚úÖ Bin directory exists"
                echo "Contents of bin directory:"
                ls -la "$PACKAGE_DIR/graphviz/bin" || echo "Failed to list bin directory"
                echo ""
                
                # Check for dot executable
                if [ "${{ matrix.platform }}" = "win32" ]; then
                  DOT_FILE="$PACKAGE_DIR/graphviz/bin/dot.exe"
                else
                  DOT_FILE="$PACKAGE_DIR/graphviz/bin/dot"
                fi
                
                if [ -f "$DOT_FILE" ]; then
                  echo "‚úÖ Dot executable found: $DOT_FILE"
                  ls -la "$DOT_FILE"
                else
                  echo "‚ùå Dot executable not found: $DOT_FILE"
                fi
              else
                echo "‚ùå Bin directory does not exist: $PACKAGE_DIR/graphviz/bin"
              fi
              
              # Check lib directory (critical for Linux)
              if [ -d "$PACKAGE_DIR/graphviz/lib" ]; then
                echo "‚úÖ Lib directory exists"
                echo "Lib directory contents:"
                ls -la "$PACKAGE_DIR/graphviz/lib" || echo "Failed to list lib directory"
                if [ "${{ matrix.platform }}" == "linux" ]; then
                  LIB_COUNT=$(find "$PACKAGE_DIR/graphviz/lib" -type f \( -name "lib*.so*" -o -name "lib*.so" \) 2>/dev/null | wc -l || echo "0")
                  echo "Found $LIB_COUNT library files"
                  if [ "$LIB_COUNT" -eq 0 ]; then
                    echo "‚ö†Ô∏è  WARNING: No library files found! This will cause runtime errors."
                  else
                    echo "Sample libraries:"
                    find "$PACKAGE_DIR/graphviz/lib" -type f \( -name "lib*.so*" -o -name "lib*.so" \) | head -10 | while read lib; do
                      echo "  - $(basename "$lib")"
                    done
                  fi
                fi
              else
                if [ "${{ matrix.platform }}" == "linux" ]; then
                  echo "‚ùå ERROR: Lib directory does not exist! This will cause runtime errors on Linux."
                else
                  echo "‚ÑπÔ∏è  Lib directory does not exist (may be OK for this platform)"
                fi
              fi
              
              # Calculate and display package size
              PACKAGE_SIZE=$(du -sh "$PACKAGE_DIR/graphviz" 2>/dev/null | cut -f1 || echo "unknown")
              PACKAGE_SIZE_BYTES=$(du -sb "$PACKAGE_DIR/graphviz" 2>/dev/null | cut -f1 || echo "0")
              echo ""
              echo "Package size: $PACKAGE_SIZE ($PACKAGE_SIZE_BYTES bytes)"
              if [ "${{ matrix.platform }}" == "linux" ] && [ "$PACKAGE_SIZE_BYTES" -lt 10485760 ]; then
                echo "‚ö†Ô∏è  WARNING: Package size is less than 10MB, may be missing libraries!"
              fi
            else
              echo "‚ùå Graphviz directory does not exist: $PACKAGE_DIR/graphviz"
            fi
          else
            echo "‚ùå Package directory does not exist: $PACKAGE_DIR"
            echo "Listing parent directory:"
            ls -la runtimes/@node-plantuml-2/ || echo "Parent directory does not exist"
          fi

      - name: Configure npm authentication (Windows)
        if: matrix.platform == 'win32'
        shell: powershell
        run: |
          Write-Host 'Configuring npm authentication for Windows...'
          $token = '${{ secrets.NPM_TOKEN }}'
          if ([string]::IsNullOrEmpty($token)) {
            Write-Host 'Error: NODE_AUTH_TOKEN is not set'
            exit 1
          }
          
          # Method 1: Try npm config set
          Write-Host 'Attempting to configure via npm config...'
          $configKey = '//registry.npmjs.org/:_authToken'
          $result = npm config set $configKey $token 2>&1
          if ($LASTEXITCODE -eq 0) {
            Write-Host 'npm authentication configured via npm config'
          } else {
            Write-Host 'npm config failed, trying direct .npmrc write...'
            # Method 2: Write .npmrc directly
            $npmrcPath = Join-Path $env:USERPROFILE '.npmrc'
            $authLine = "//registry.npmjs.org/:_authToken=$token"
            
            # Read existing content if it exists
            $existingContent = ''
            if (Test-Path $npmrcPath) {
              $existingContent = Get-Content $npmrcPath -Raw
            }
            
            # Remove any existing auth token lines
            $lines = $existingContent -split "`n" | Where-Object { 
              $_ -notmatch '//registry\.npmjs\.org/:_authToken' 
            }
            
            # Add new auth token
            $newContent = ($lines + $authLine) -join "`n"
            if (-not $newContent.EndsWith("`n")) {
              $newContent += "`n"
            }
            
            try {
              Set-Content -Path $npmrcPath -Value $newContent -NoNewline
              Write-Host 'npm authentication configured via .npmrc file'
            } catch {
              Write-Host "Error writing .npmrc: $_"
              exit 1
            }
          }
          
          # Verify .npmrc exists and contains token
          $npmrcPath = Join-Path $env:USERPROFILE '.npmrc'
          if (Test-Path $npmrcPath) {
            $content = Get-Content $npmrcPath -Raw
            if ($content -match '_authToken') {
              Write-Host '.npmrc file verified'
            } else {
              Write-Host 'Warning: .npmrc exists but no auth token found'
            }
          } else {
            Write-Host 'Warning: .npmrc file not found'
          }
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify NPM authentication
        shell: bash
        run: |
          echo "üîç Verifying npm authentication..."
          npm whoami || {
            echo "‚ùå Error: Not authenticated to npm"
            echo "Attempting to debug..."
            if [ "${{ matrix.platform }}" = "win32" ]; then
              echo "Windows platform detected"
              echo "Checking .npmrc location..."
              if [ -f "$USERPROFILE/.npmrc" ]; then
                echo "Found .npmrc at: $USERPROFILE/.npmrc"
                echo "First few lines (sanitized):"
                head -n 3 "$USERPROFILE/.npmrc" 2>/dev/null | sed 's/_authToken=.*/_authToken=***/' || echo "Could not read .npmrc"
              else
                echo ".npmrc not found at: $USERPROFILE/.npmrc"
              fi
            else
              echo "Checking .npmrc location..."
              if [ -f "$HOME/.npmrc" ]; then
                echo "Found .npmrc at: $HOME/.npmrc"
                echo "First few lines (sanitized):"
                head -n 3 "$HOME/.npmrc" | sed 's/_authToken=.*/_authToken=***/'
              else
                echo ".npmrc not found at: $HOME/.npmrc"
              fi
            fi
            exit 1
          }
          echo "‚úÖ Successfully authenticated to npm"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Check if Graphviz package version exists
        id: check-version-graphviz
        shell: bash
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          if npm view ${{ matrix.package }}@$VERSION version > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Version $VERSION already exists for ${{ matrix.package }}"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Version $VERSION is available for ${{ matrix.package }}"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

      - name: Verify Graphviz package structure
        shell: bash
        run: |
          echo "üîç Verifying Graphviz package structure..."
          node scripts/verify-graphviz-package.js ${{ matrix.platform }} ${{ matrix.arch }}
          if [ $? -ne 0 ]; then
            echo "‚ùå Graphviz package structure verification failed"
            exit 1
          fi
          echo "‚úÖ Graphviz package structure verification passed"

      - name: Setup Java for testing
        shell: bash
        run: |
          echo "‚òï Setting up Java for end-to-end testing..."
          # Check if bundled JRE exists, otherwise use system Java
          if [ "${{ matrix.platform }}" = "win32" ]; then
            JRE_PATH="runtimes/@node-plantuml-2/jre-${{ matrix.platform }}-${{ matrix.arch }}/jre/bin/java.exe"
          else
            JRE_PATH="runtimes/@node-plantuml-2/jre-${{ matrix.platform }}-${{ matrix.arch }}/jre/bin/java"
          fi
          
          if [ -f "$JRE_PATH" ]; then
            echo "‚úì Using bundled JRE: $JRE_PATH"
            chmod +x "$JRE_PATH" || true
            "$JRE_PATH" -version
          else
            echo "‚ö†Ô∏è  Bundled JRE not found, using system Java"
            java -version || {
              echo "‚ùå No Java found (neither bundled nor system)"
              exit 1
            }
          fi

      - name: Download PlantUML JAR for testing
        shell: bash
        run: |
          echo "üì• Downloading PlantUML JAR for testing..."
          if [ ! -f "vendor/plantuml.jar" ]; then
            node scripts/get-plantuml-jar.js --latest || {
              echo "‚ùå Failed to download PlantUML JAR"
              exit 1
            }
          else
            echo "‚úì PlantUML JAR already exists"
          fi

      - name: 'End-to-end test: Generate PlantUML diagrams with Graphviz'
        shell: bash
        run: |
          echo "üß™ Running end-to-end test: Generating PlantUML diagrams with Graphviz..."
          echo ""
          node scripts/test-graphviz-package-end-to-end.js ${{ matrix.platform }} ${{ matrix.arch }} ./test-output-graphviz-e2e
          if [ $? -ne 0 ]; then
            echo ""
            echo "‚ùå End-to-end test failed! Graphviz package cannot generate diagrams."
            exit 1
          fi
          echo ""
          echo "‚úÖ End-to-end test passed! Graphviz package works correctly."

      - name: Upload generated diagrams as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: graphviz-test-output-${{ matrix.platform }}-${{ matrix.arch }}
          path: test-output-graphviz-e2e/*.png
          retention-days: 7
          if-no-files-found: warn

      - name: Upload generated SVG diagrams as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: graphviz-test-output-svg-${{ matrix.platform }}-${{ matrix.arch }}
          path: test-output-graphviz-e2e/*.svg
          retention-days: 7
          if-no-files-found: warn

      - name: Publish Graphviz runtime package
        if: steps.check-version-graphviz.outputs.exists != 'true'
        shell: bash
        run: |
          echo "üì¶ Publishing ${{ matrix.package }}@${{ needs.prepare.outputs.version }}..."
          node scripts/publish-runtime-package.js graphviz ${{ matrix.platform }} ${{ matrix.arch }} --version ${{ needs.prepare.outputs.version }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish Graphviz runtime package (skip if exists)
        if: steps.check-version-graphviz.outputs.exists == 'true'
        shell: bash
        run: |
          echo "‚ÑπÔ∏è  Version ${{ needs.prepare.outputs.version }} already exists for ${{ matrix.package }}, skipping publish"

  publish-main:
    needs: [prepare, build-and-publish-runtimes, build-and-publish-graphviz]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          ref: ${{ github.event.release.tag_name || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Download PlantUML JAR from artifact
        id: download-vendor
        uses: actions/download-artifact@v4
        if: always()
        with:
          name: vendor-files
          path: vendor/
          merge-multiple: true

      - name: Download PlantUML JAR (fallback if artifact missing)
        shell: bash
        if: steps.download-vendor.outcome == 'failure'
        run: |
          echo "üì• Artifact not available - Downloading PlantUML JAR (fallback)..."
          node scripts/get-plantuml-jar.js --latest || echo "JAR download failed, but continuing..."
        continue-on-error: true

      - name: Verify PlantUML JAR exists
        shell: bash
        run: |
          if [ ! -f "vendor/plantuml.jar" ]; then
            echo "üì• PlantUML JAR not found - Downloading..."
            node scripts/get-plantuml-jar.js --latest || echo "JAR download failed, but continuing..."
          else
            echo "‚úì PlantUML JAR found"
          fi
        continue-on-error: true

      - name: Update version and optionalDependencies
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "üì¶ Updating main package to version $VERSION"
          
          # Update version
          npm version $VERSION --no-git-tag-version --allow-same-version
          
          # Update optionalDependencies to match runtime package versions
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            const version = '$VERSION';
            
            pkg.optionalDependencies = {
              '@node-plantuml-2/jre-win32-x64': '^' + version,
              '@node-plantuml-2/jre-darwin-arm64': '^' + version,
              '@node-plantuml-2/jre-linux-x64': '^' + version,
              '@node-plantuml-2/graphviz-win32-x64': '^' + version,
              '@node-plantuml-2/graphviz-darwin-arm64': '^' + version,
              '@node-plantuml-2/graphviz-darwin-x64': '^' + version,
              '@node-plantuml-2/graphviz-linux-x64': '^' + version
            };
            
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            console.log('‚úÖ Updated optionalDependencies to version ' + version);
          "

      - name: Download PlantUML JAR from artifact
        id: download-vendor-main
        uses: actions/download-artifact@v4
        if: always()
        with:
          name: vendor-files
          path: vendor/
          merge-multiple: true

      - name: Download PlantUML JAR (fallback if artifact missing)
        shell: bash
        if: |
          always() && 
          (steps.download-vendor-main.outcome == 'failure' || 
           !hashFiles('vendor/plantuml.jar'))
        run: |
          echo "üì• Artifact not available - Downloading PlantUML JAR (fallback)..."
          node scripts/get-plantuml-jar.js --latest || echo "JAR download failed, but continuing..."
        continue-on-error: true

      - name: Verify NPM authentication
        run: |
          echo "üîç Verifying npm authentication..."
          npm whoami || {
            echo "‚ùå Error: Not authenticated to npm"
            exit 1
          }
          echo "‚úÖ Successfully authenticated to npm"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify version before publish
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "üì¶ Preparing to publish main package version: $VERSION"

          if npm view node-plantuml-2@$VERSION version > /dev/null 2>&1; then
            echo "‚ùå Error: Version $VERSION already exists on npm registry"
            exit 1
          fi

          echo "‚úÖ Version $VERSION is ready to publish"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish main package
        run: |
          echo "üì¶ Publishing main package to npm..."
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: false

      - name: Create Git tag and push (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          # Add package.json and lock files if they exist
          git add package.json
          [ -f package-lock.json ] && git add package-lock.json || true
          [ -f yarn.lock ] && git add yarn.lock || true
          [ -f pnpm-lock.yaml ] && git add pnpm-lock.yaml || true

          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è  No changes to commit"
          else
            git commit -m "chore: bump version to $VERSION" || echo "Nothing to commit"
          fi

          echo "üîÑ Pulling latest changes from remote..."
          DEFAULT_BRANCH=$(git remote show origin | grep "HEAD branch" | cut -d" " -f5 || echo "")
          if [ -z "$DEFAULT_BRANCH" ]; then
            for branch in main master; do
              if git ls-remote --heads origin $branch | grep -q .; then
                DEFAULT_BRANCH=$branch
                break
              fi
            done
          fi
          if [ -z "$DEFAULT_BRANCH" ]; then
            DEFAULT_BRANCH="main"
          fi
          echo "üîÑ Using branch: $DEFAULT_BRANCH"
          git fetch origin $DEFAULT_BRANCH || true
          git pull origin $DEFAULT_BRANCH --rebase || git pull origin $DEFAULT_BRANCH --no-edit || {
            echo "‚ö†Ô∏è  Warning: Failed to sync with remote, but continuing..."
          }

          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Tag v$VERSION already exists locally"
          else
            git tag -a "v$VERSION" -m "Release v$VERSION"
          fi

          echo "üì§ Pushing changes to remote..."
          git push origin HEAD:$DEFAULT_BRANCH || {
            echo "‚ùå Failed to push to branch: $DEFAULT_BRANCH"
            exit 1
          }

          if git ls-remote --tags origin | grep -q "refs/tags/v$VERSION$"; then
            echo "‚ÑπÔ∏è  Tag v$VERSION already exists on remote"
          else
            git push origin "v$VERSION" || {
              echo "‚ö†Ô∏è  Failed to push tag, but code was pushed successfully"
            }
          fi

          echo "‚úÖ Successfully pushed version $VERSION"

      - name: Create GitHub Release (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: Release v${{ needs.prepare.outputs.version }}
          body: |
            ## Changes in v${{ needs.prepare.outputs.version }}

            See [CHANGELOG.md](CHANGELOG.md) for details.

            ### ‚ú® Features
            - Bundled JRE support (no Java installation required)
            - Multiple output formats (PNG, SVG, EPS, ASCII, Unicode)
            - Full UTF-8 and Chinese character support
            - Platform-specific JRE runtime packages
          draft: false
          prerelease: false
